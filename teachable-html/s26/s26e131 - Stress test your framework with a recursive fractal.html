<h2 id="stress-test-your-framework-with-a-recursive-fractal">
  Stress test your framework with a recursive fractal
</h2>
<p>
  To show you how these speed improvements look in real life, I’ve devised
  a stress test. A
  <a href="https://en.wikipedia.org/wiki/Pythagoras_tree_(fractal)"
    >pythagorean fractal tree</a
  >
  that moves around when you move your mouse.
</p>
<figure>
  <img
    src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/pythagorean-tree.png"
    alt="Pythagorean tree"
  />
  <figcaption>Pythagorean tree</figcaption>
</figure>
<p>
  It’s a great stress test because a render like this is the worst case
  scenario for tree-based rendering. You have 2048 SVG nodes, deeply
  nested, that all change props and re-render with every change.
</p>
<p>
  You can see
  <a href="https://github.com/Swizec/react-fractals"
    >the full code on Github</a
  >. We’re going to focus on the recursive
  <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code> component.
</p>
<h3 id="how-you-too-can-build-a-dancing-tree-fractal">
  How you too can build a dancing tree fractal
</h3>
<p>
  Equipped with basic trigonometry, you need 3 ingredients to build a
  dancing tree:
</p>
<ul>
  <li>
    a recursive
    <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code>
    component
  </li>
  <li>a mousemove listener</li>
  <li>a memoized next-step-props calculation function</li>
</ul>
<p>
  We’re using a
  <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code> component
  for each square and its two children, a D3 mouse listener, and some math
  that a reader helped me with. We need D3 because its mouse listeners
  automatically calculate mouse position relative to SVG coordinates.
  <a href="https://en.wikipedia.org/wiki/Memoization">Memoization</a> in
  the math function helps us keep our code faster.
</p>
<p>
  The
  <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code> component
  looks like this:
</p>
<div
  class="sourceCode"
  id="cb183"
  data-caption="Recursive &lt;Pythagoras&gt; component"
  style="overflow: visible; margin: 1em 0;"
>
  <pre
    class="sourceCode javascript"
    style="overflow: visible; margin: 0;"
  ><code class="sourceCode javascript" style="overflow: visible; white-space: pre; position: relative;"><a class="sourceLine" id="cb183-1" title="1" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="kw" style="color: #007020; font-weight: bold;">const</span> Pythagoras <span class="op" style="color: #666666;">=</span> (<span class="op" style="color: #666666;">{</span> w<span class="op" style="color: #666666;">,</span> x<span class="op" style="color: #666666;">,</span> y<span class="op" style="color: #666666;">,</span> heightFactor<span class="op" style="color: #666666;">,</span> lean<span class="op" style="color: #666666;">,</span> left<span class="op" style="color: #666666;">,</span> right<span class="op" style="color: #666666;">,</span> lvl<span class="op" style="color: #666666;">,</span> maxlvl <span class="op" style="color: #666666;">}</span>) <span class="op" style="color: #666666;">=&gt;</span> <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb183-2" title="2" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="cf" style="color: #007020; font-weight: bold;">if</span> (lvl <span class="op" style="color: #666666;">&gt;=</span> maxlvl <span class="op" style="color: #666666;">||</span> w <span class="op" style="color: #666666;">&lt;</span> <span class="dv" style="color: #40a070;">1</span>) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb183-3" title="3" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="cf" style="color: #007020; font-weight: bold;">return</span> <span class="kw" style="color: #007020; font-weight: bold;">null</span><span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-4" title="4" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-5" title="5" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-6" title="6" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="kw" style="color: #007020; font-weight: bold;">const</span> <span class="op" style="color: #666666;">{</span> nextRight<span class="op" style="color: #666666;">,</span> nextLeft<span class="op" style="color: #666666;">,</span> A<span class="op" style="color: #666666;">,</span> B <span class="op" style="color: #666666;">}</span> <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">memoizedCalc</span>(<span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb183-7" title="7" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">w</span><span class="op" style="color: #666666;">:</span> w<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb183-8" title="8" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">heightFactor</span><span class="op" style="color: #666666;">:</span> heightFactor<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb183-9" title="9" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">lean</span><span class="op" style="color: #666666;">:</span> lean</a>
<a class="sourceLine" id="cb183-10" title="10" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">}</span>)<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-11" title="11" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-12" title="12" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="kw" style="color: #007020; font-weight: bold;">let</span> rotate <span class="op" style="color: #666666;">=</span> <span class="st" style="color: #4070a0;">&#39;&#39;</span><span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-13" title="13" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-14" title="14" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="cf" style="color: #007020; font-weight: bold;">if</span> (left) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb183-15" title="15" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        rotate <span class="op" style="color: #666666;">=</span> <span class="vs" style="color: #4070a0;">`rotate(</span><span class="sc" style="color: #4070a0;">${</span><span class="op" style="color: #666666;">-</span>A<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;"> 0 </span><span class="sc" style="color: #4070a0;">${</span>w<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;">)`</span><span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-16" title="16" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">}</span><span class="cf" style="color: #007020; font-weight: bold;">else</span> <span class="cf" style="color: #007020; font-weight: bold;">if</span> (right) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb183-17" title="17" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        rotate <span class="op" style="color: #666666;">=</span> <span class="vs" style="color: #4070a0;">`rotate(</span><span class="sc" style="color: #4070a0;">${</span>B<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;"> </span><span class="sc" style="color: #4070a0;">${</span>w<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;"> </span><span class="sc" style="color: #4070a0;">${</span>w<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;">)`</span><span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-18" title="18" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-19" title="19" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-20" title="20" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="cf" style="color: #007020; font-weight: bold;">return</span> (</a>
<a class="sourceLine" id="cb183-21" title="21" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="op" style="color: #666666;">&lt;</span>g transform<span class="op" style="color: #666666;">={</span><span class="vs" style="color: #4070a0;">`translate(</span><span class="sc" style="color: #4070a0;">${</span>x<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;"> </span><span class="sc" style="color: #4070a0;">${</span>y<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;">) </span><span class="sc" style="color: #4070a0;">${</span>rotate<span class="sc" style="color: #4070a0;">}</span><span class="vs" style="color: #4070a0;">`</span><span class="op" style="color: #666666;">}&gt;</span></a>
<a class="sourceLine" id="cb183-22" title="22" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="op" style="color: #666666;">&lt;</span>rect width<span class="op" style="color: #666666;">={</span>w<span class="op" style="color: #666666;">}</span> height<span class="op" style="color: #666666;">={</span>w<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-23" title="23" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                  x<span class="op" style="color: #666666;">={</span><span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">}</span> y<span class="op" style="color: #666666;">={</span><span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-24" title="24" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                  style<span class="op" style="color: #666666;">={{</span><span class="dt">fill</span><span class="op">:</span> <span class="at">interpolateViridis</span>(lvl/maxlvl)<span class="op">}}</span> /&gt;</a>
<a class="sourceLine" id="cb183-25" title="25" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-26" title="26" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="op" style="color: #666666;">&lt;</span>Pythagoras w<span class="op" style="color: #666666;">={</span>nextLeft<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-27" title="27" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        x<span class="op" style="color: #666666;">={</span><span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">}</span> y<span class="op" style="color: #666666;">={-</span>nextLeft<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-28" title="28" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        lvl<span class="op" style="color: #666666;">={</span>lvl<span class="op" style="color: #666666;">+</span><span class="dv" style="color: #40a070;">1</span><span class="op" style="color: #666666;">}</span> maxlvl<span class="op" style="color: #666666;">={</span>maxlvl<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-29" title="29" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        heightFactor<span class="op" style="color: #666666;">={</span>heightFactor<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-30" title="30" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        lean<span class="op" style="color: #666666;">={</span>lean<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-31" title="31" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        left /<span class="op" style="color: #666666;">&gt;</span></a>
<a class="sourceLine" id="cb183-32" title="32" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-33" title="33" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="op" style="color: #666666;">&lt;</span>Pythagoras w<span class="op" style="color: #666666;">={</span>nextRight<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-34" title="34" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        x<span class="op" style="color: #666666;">={</span>w<span class="op" style="color: #666666;">-</span>nextRight<span class="op" style="color: #666666;">}</span> y<span class="op" style="color: #666666;">={-</span>nextRight<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-35" title="35" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        lvl<span class="op" style="color: #666666;">={</span>lvl<span class="op" style="color: #666666;">+</span><span class="dv" style="color: #40a070;">1</span><span class="op" style="color: #666666;">}</span> maxlvl<span class="op" style="color: #666666;">={</span>maxlvl<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-36" title="36" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        heightFactor<span class="op" style="color: #666666;">={</span>heightFactor<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-37" title="37" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        lean<span class="op" style="color: #666666;">={</span>lean<span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb183-38" title="38" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                        right /<span class="op" style="color: #666666;">&gt;</span></a>
<a class="sourceLine" id="cb183-39" title="39" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb183-40" title="40" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        &lt;/g<span class="op" style="color: #666666;">&gt;</span></a>
<a class="sourceLine" id="cb183-41" title="41" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    )<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb183-42" title="42" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">};</span></a></code></pre>
</div>
<p>
  We break out of recursion when we get too deep or try to draw an
  invisible square. Otherwise we:
</p>
<ul>
  <li>
    use <code style="white-space: pre-wrap;">memoizedCalc</code> to do the
    mathematics
  </li>
  <li>
    define different
    <code style="white-space: pre-wrap;">rotate()</code> transforms for the
    <code style="white-space: pre-wrap;">left</code> and
    <code style="white-space: pre-wrap;">right</code> branches
  </li>
  <li>
    return an SVG
    <code style="white-space: pre-wrap;">&lt;rect&gt;</code> for the
    current rectangle, and two
    <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code> elements
    for each branch.
  </li>
</ul>
<p>
  Most of this code deals with passing props to children, which isn’t the
  most elegant approach, but it works. The rest is about positioning
  branches so corners match up.
</p>
<figure>
  <img
    src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/pythagoras-corners-match-up.png"
    alt="Corners matching up"
  />
  <figcaption>Corners matching up</figcaption>
</figure>
<h4 id="the-math">The math</h4>
<p>
  I don’t <em>really</em> understand this math, but I sort of know where
  it’s coming from. It’s the
  <a href="https://en.wikipedia.org/wiki/Law_of_sines">sine law</a> applied
  correctly. The part I failed at
  <a href="https://swizec.com/blog/fractals-react/swizec/7233"
    >when I tried</a
  >
  to do it myself.
</p>
<div
  class="sourceCode"
  id="cb184"
  data-caption="Trigonometry that moves our fractal"
  style="overflow: visible; margin: 1em 0;"
>
  <pre
    class="sourceCode javascript"
    style="overflow: visible; margin: 0;"
  ><code class="sourceCode javascript" style="overflow: visible; white-space: pre; position: relative;"><a class="sourceLine" id="cb184-1" title="1" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="kw" style="color: #007020; font-weight: bold;">const</span> memoizedCalc <span class="op" style="color: #666666;">=</span> <span class="kw" style="color: #007020; font-weight: bold;">function</span> () <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb184-2" title="2" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="kw" style="color: #007020; font-weight: bold;">const</span> memo <span class="op" style="color: #666666;">=</span> <span class="op" style="color: #666666;">{};</span></a>
<a class="sourceLine" id="cb184-3" title="3" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-4" title="4" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="kw" style="color: #007020; font-weight: bold;">const</span> key <span class="op" style="color: #666666;">=</span> (<span class="op" style="color: #666666;">{</span> w<span class="op" style="color: #666666;">,</span> heightFactor<span class="op" style="color: #666666;">,</span> lean <span class="op" style="color: #666666;">}</span>) <span class="op" style="color: #666666;">=&gt;</span> [w<span class="op" style="color: #666666;">,</span>heightFactor<span class="op" style="color: #666666;">,</span> lean].<span class="at" style="color: #7d9029;">join</span>(<span class="st" style="color: #4070a0;">&#39;-&#39;</span>)<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-5" title="5" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-6" title="6" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="cf" style="color: #007020; font-weight: bold;">return</span> (args) <span class="op" style="color: #666666;">=&gt;</span> <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb184-7" title="7" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="kw" style="color: #007020; font-weight: bold;">const</span> memoKey <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">key</span>(args)<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-8" title="8" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-9" title="9" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="cf" style="color: #007020; font-weight: bold;">if</span> (memo[memoKey]) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb184-10" title="10" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="cf" style="color: #007020; font-weight: bold;">return</span> memo[memoKey]<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-11" title="11" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="op" style="color: #666666;">}</span><span class="cf" style="color: #007020; font-weight: bold;">else</span><span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb184-12" title="12" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="kw" style="color: #007020; font-weight: bold;">const</span> <span class="op" style="color: #666666;">{</span> w<span class="op" style="color: #666666;">,</span> heightFactor<span class="op" style="color: #666666;">,</span> lean <span class="op" style="color: #666666;">}</span> <span class="op" style="color: #666666;">=</span> args<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-13" title="13" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-14" title="14" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="kw" style="color: #007020; font-weight: bold;">const</span> trigH <span class="op" style="color: #666666;">=</span> heightFactor<span class="op" style="color: #666666;">*</span>w<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-15" title="15" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-16" title="16" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="kw" style="color: #007020; font-weight: bold;">const</span> result <span class="op" style="color: #666666;">=</span> <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb184-17" title="17" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                <span class="dt" style="color: #902000;">nextRight</span><span class="op" style="color: #666666;">:</span> <span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">sqrt</span>(trigH<span class="op" style="color: #666666;">**</span><span class="dv" style="color: #40a070;">2</span> <span class="op" style="color: #666666;">+</span> (w <span class="op" style="color: #666666;">*</span> (.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">+</span>lean))<span class="op" style="color: #666666;">**</span><span class="dv" style="color: #40a070;">2</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb184-18" title="18" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                <span class="dt" style="color: #902000;">nextLeft</span><span class="op" style="color: #666666;">:</span> <span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">sqrt</span>(trigH<span class="op" style="color: #666666;">**</span><span class="dv" style="color: #40a070;">2</span> <span class="op" style="color: #666666;">+</span> (w <span class="op" style="color: #666666;">*</span> (.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">-</span>lean))<span class="op" style="color: #666666;">**</span><span class="dv" style="color: #40a070;">2</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb184-19" title="19" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                <span class="dt" style="color: #902000;">A</span><span class="op" style="color: #666666;">:</span> <span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">deg</span>(<span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">atan</span>(trigH / ((.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">-</span>lean) <span class="op" style="color: #666666;">*</span> w)))<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb184-20" title="20" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                <span class="dt" style="color: #902000;">B</span><span class="op" style="color: #666666;">:</span> <span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">deg</span>(<span class="va" style="color: #19177c;">Math</span>.<span class="at" style="color: #7d9029;">atan</span>(trigH / ((.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">+</span>lean) <span class="op" style="color: #666666;">*</span> w)))</a>
<a class="sourceLine" id="cb184-21" title="21" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="op" style="color: #666666;">};</span></a>
<a class="sourceLine" id="cb184-22" title="22" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb184-23" title="23" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            memo[memoKey] <span class="op" style="color: #666666;">=</span> result<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-24" title="24" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">            <span class="cf" style="color: #007020; font-weight: bold;">return</span> result<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb184-25" title="25" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb184-26" title="26" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb184-27" title="27" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">}</span>()<span class="op" style="color: #666666;">;</span></a></code></pre>
</div>
<p>
  We expanded the basic law of sines with a dynamic
  <code style="white-space: pre-wrap;">heightFactor</code> and
  <code style="white-space: pre-wrap;">lean</code> adjustment. We’ll
  control those with mouse movement.
</p>
<p>
  To improve performance our
  <code style="white-space: pre-wrap;">memoizedCalc</code> function has an
  internal data store that maintains a hash of every argument tuple and its
  result. So when we call
  <code style="white-space: pre-wrap;">memoizedCalc</code> with the same
  arguments multiple times, it reads from cache instead of recalculating.
</p>
<p>
  At 11 levels of recursion,
  <code style="white-space: pre-wrap;">memoizedCalc</code> is called 2,048
  times and only returns 11 different results. Great candidate for
  memoization if I ever saw one.
</p>
<p>
  Of course, a benchmark would be great here. Maybe
  <code style="white-space: pre-wrap;">sqrt</code>,
  <code style="white-space: pre-wrap;">atan</code>, and
  <code style="white-space: pre-wrap;">**</code> aren’t <em>that</em> slow,
  and our real bottleneck is redrawing all those nodes on every mouse move.
  Hint: it totally is.
</p>
<p>
  Our ability to memoize calculation also means that we could, in theory,
  flatten our rendering. Instead of recursion, we could use iteration and
  render in layers. Squares at each level are the same, just at different
  <code style="white-space: pre-wrap;">(x, y)</code> coordinates.
</p>
<p>This, however, would be far too tricky to implement.</p>
<h4 id="the-mouse-listener">The mouse listener</h4>
<p>
  Inside
  <a href="https://github.com/Swizec/react-fractals/blob/master/src/App.js"
    ><code style="white-space: pre-wrap;">App.js</code></a
  >, we add a mouse event listener. We use D3’s because it gives us
  SVG-relative position calculation out of the box. With React’s, we’d have
  to do the hard work ourselves.
</p>
<div
  class="sourceCode"
  id="cb185"
  data-caption="Reacting to mouse movement"
  style="overflow: visible; margin: 1em 0;"
>
  <pre
    class="sourceCode javascript"
    style="overflow: visible; margin: 0;"
  ><code class="sourceCode javascript" style="overflow: visible; white-space: pre; position: relative;"><a class="sourceLine" id="cb185-1" title="1" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="co" style="color: #60a0b0; font-style: italic;">// App.js</span></a>
<a class="sourceLine" id="cb185-2" title="2" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">state <span class="op" style="color: #666666;">=</span> <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb185-3" title="3" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">currentMax</span><span class="op" style="color: #666666;">:</span> <span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-4" title="4" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">baseW</span><span class="op" style="color: #666666;">:</span> <span class="dv" style="color: #40a070;">80</span><span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-5" title="5" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">heightFactor</span><span class="op" style="color: #666666;">:</span> <span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-6" title="6" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">        <span class="dt" style="color: #902000;">lean</span><span class="op" style="color: #666666;">:</span> <span class="dv" style="color: #40a070;">0</span></a>
<a class="sourceLine" id="cb185-7" title="7" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="op" style="color: #666666;">};</span></a>
<a class="sourceLine" id="cb185-8" title="8" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-9" title="9" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="at" style="color: #7d9029;">componentDidMount</span>() <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb185-10" title="10" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="at" style="color: #7d9029;">d3select</span>(<span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">refs</span>.<span class="at" style="color: #7d9029;">svg</span>)</a>
<a class="sourceLine" id="cb185-11" title="11" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">     .<span class="at" style="color: #7d9029;">on</span>(<span class="st" style="color: #4070a0;">&quot;mousemove&quot;</span><span class="op" style="color: #666666;">,</span> <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">onMouseMove</span>.<span class="at" style="color: #7d9029;">bind</span>(<span class="kw" style="color: #007020; font-weight: bold;">this</span>))<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb185-12" title="12" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-13" title="13" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-14" title="14" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="at" style="color: #7d9029;">onMouseMove</span>(event) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb185-15" title="15" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="kw" style="color: #007020; font-weight: bold;">const</span> [x<span class="op" style="color: #666666;">,</span> y] <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">d3mouse</span>(<span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">refs</span>.<span class="at" style="color: #7d9029;">svg</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-16" title="16" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-17" title="17" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  scaleFactor <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">scaleLinear</span>().<span class="at" style="color: #7d9029;">domain</span>([<span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">height</span><span class="op" style="color: #666666;">,</span> <span class="dv" style="color: #40a070;">0</span>])</a>
<a class="sourceLine" id="cb185-18" title="18" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                             .<span class="at" style="color: #7d9029;">range</span>([<span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> .<span class="op" style="color: #666666;">:</span><span class="dt" style="color: #902000;">sunglasses</span><span class="op" style="color: #666666;">:</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-19" title="19" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-20" title="20" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  scaleLean <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">scaleLinear</span>().<span class="at" style="color: #7d9029;">domain</span>([<span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">width</span>/<span class="dv" style="color: #40a070;">2</span><span class="op" style="color: #666666;">,</span> <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">width</span>])</a>
<a class="sourceLine" id="cb185-21" title="21" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                           .<span class="at" style="color: #7d9029;">range</span>([.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">,</span> <span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> <span class="fl" style="color: #40a070;">-.5</span>])<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb185-22" title="22" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-23" title="23" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="at" style="color: #7d9029;">setState</span>(<span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb185-24" title="24" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="dt" style="color: #902000;">heightFactor</span><span class="op" style="color: #666666;">:</span> <span class="at" style="color: #7d9029;">scaleFactor</span>(y)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb185-25" title="25" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="dt" style="color: #902000;">lean</span><span class="op" style="color: #666666;">:</span> <span class="at" style="color: #7d9029;">scaleLean</span>(<span class="op" style="color: #666666;">:</span><span class="dt" style="color: #902000;">satisfied</span><span class="op" style="color: #666666;">:</span></a>
<a class="sourceLine" id="cb185-26" title="26" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="op" style="color: #666666;">}</span>)<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb185-27" title="27" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-28" title="28" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-29" title="29" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="co" style="color: #60a0b0; font-style: italic;">// ...</span></a>
<a class="sourceLine" id="cb185-30" title="30" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb185-31" title="31" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="at" style="color: #7d9029;">render</span>() <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb185-32" title="32" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="co" style="color: #60a0b0; font-style: italic;">// ...</span></a>
<a class="sourceLine" id="cb185-33" title="33" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="op" style="color: #666666;">&lt;</span>svg ref<span class="op" style="color: #666666;">=</span><span class="st" style="color: #4070a0;">&quot;svg&quot;</span><span class="op" style="color: #666666;">&gt;</span> <span class="co" style="color: #60a0b0; font-style: italic;">//...</span></a>
<a class="sourceLine" id="cb185-34" title="34" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="op" style="color: #666666;">&lt;</span>Pythagoras w<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">baseW</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-35" title="35" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">              h<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">baseW</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-36" title="36" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">              heightFactor<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">heightFactor</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-37" title="37" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">             lean<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">lean</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-38" title="38" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">             x<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">width</span>/<span class="dv" style="color: #40a070;">2-40</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-39" title="39" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">             y<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">height</span><span class="op" style="color: #666666;">-</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">baseW</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-40" title="40" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">             lvl<span class="op" style="color: #666666;">={</span><span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">}</span></a>
<a class="sourceLine" id="cb185-41" title="41" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">             maxlvl<span class="op" style="color: #666666;">={</span><span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">state</span>.<span class="at" style="color: #7d9029;">currentMax</span><span class="op" style="color: #666666;">}</span>/&gt;</a>
<a class="sourceLine" id="cb185-42" title="42" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">}</span></a></code></pre>
</div>
<p>A few things happen here:</p>
<ul>
  <li>
    we set initial <code style="white-space: pre-wrap;">lean</code> and
    <code style="white-space: pre-wrap;">heightFactor</code> to
    <code style="white-space: pre-wrap;">0</code>
  </li>
  <li>
    in <code style="white-space: pre-wrap;">componentDidMount</code>, we
    use <code style="white-space: pre-wrap;">d3.select</code> and
    <code style="white-space: pre-wrap;">.on</code> to add a mouse listener
  </li>
  <li>
    we define an
    <code style="white-space: pre-wrap;">onMouseMove</code> method as the
    listener
  </li>
  <li>
    render the first
    <code style="white-space: pre-wrap;">&lt;Pythagoras&gt;</code> using
    values from <code style="white-space: pre-wrap;">state</code>
  </li>
</ul>
<p>
  The <code style="white-space: pre-wrap;">lean</code> parameter tells us
  which way the tree is leaning and how much, the
  <code style="white-space: pre-wrap;">heightFactor</code> tells us how
  high those triangles should be. We control both with the mouse position.
</p>
<p>
  That happens in <code style="white-space: pre-wrap;">onMouseMove</code>:
</p>
<div
  class="sourceCode"
  id="cb186"
  data-caption="Moving the fractal as user moves mouse"
  style="overflow: visible; margin: 1em 0;"
>
  <pre
    class="sourceCode javascript"
    style="overflow: visible; margin: 0;"
  ><code class="sourceCode javascript" style="overflow: visible; white-space: pre; position: relative;"><a class="sourceLine" id="cb186-1" title="1" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="at" style="color: #7d9029;">onMouseMove</span>(event) <span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb186-2" title="2" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="kw" style="color: #007020; font-weight: bold;">const</span> [x<span class="op" style="color: #666666;">,</span> y] <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">d3mouse</span>(<span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">refs</span>.<span class="at" style="color: #7d9029;">svg</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb186-3" title="3" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb186-4" title="4" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  scaleFactor <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">scaleLinear</span>().<span class="at" style="color: #7d9029;">domain</span>([<span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">height</span><span class="op" style="color: #666666;">,</span> <span class="dv" style="color: #40a070;">0</span>])</a>
<a class="sourceLine" id="cb186-5" title="5" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                             .<span class="at" style="color: #7d9029;">range</span>([<span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> .<span class="op" style="color: #666666;">:</span><span class="dt" style="color: #902000;">sunglasses</span><span class="op" style="color: #666666;">:</span>)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb186-6" title="6" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb186-7" title="7" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  scaleLean <span class="op" style="color: #666666;">=</span> <span class="at" style="color: #7d9029;">scaleLinear</span>().<span class="at" style="color: #7d9029;">domain</span>([<span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">width</span>/<span class="dv" style="color: #40a070;">2</span><span class="op" style="color: #666666;">,</span> <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="va" style="color: #19177c;">svg</span>.<span class="at" style="color: #7d9029;">width</span>])</a>
<a class="sourceLine" id="cb186-8" title="8" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">                           .<span class="at" style="color: #7d9029;">range</span>([.<span class="dv" style="color: #40a070;">5</span><span class="op" style="color: #666666;">,</span> <span class="dv" style="color: #40a070;">0</span><span class="op" style="color: #666666;">,</span> <span class="fl" style="color: #40a070;">-.5</span>])<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb186-9" title="9" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit; height: 1.2em;"></a>
<a class="sourceLine" id="cb186-10" title="10" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="kw" style="color: #007020; font-weight: bold;">this</span>.<span class="at" style="color: #7d9029;">setState</span>(<span class="op" style="color: #666666;">{</span></a>
<a class="sourceLine" id="cb186-11" title="11" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="dt" style="color: #902000;">heightFactor</span><span class="op" style="color: #666666;">:</span> <span class="at" style="color: #7d9029;">scaleFactor</span>(y)<span class="op" style="color: #666666;">,</span></a>
<a class="sourceLine" id="cb186-12" title="12" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">    <span class="dt" style="color: #902000;">lean</span><span class="op" style="color: #666666;">:</span> <span class="at" style="color: #7d9029;">scaleLean</span>(<span class="op" style="color: #666666;">:</span><span class="dt" style="color: #902000;">satisfied</span><span class="op" style="color: #666666;">:</span></a>
<a class="sourceLine" id="cb186-13" title="13" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;">  <span class="op" style="color: #666666;">}</span>)<span class="op" style="color: #666666;">;</span></a>
<a class="sourceLine" id="cb186-14" title="14" style="display: inline-block; line-height: 1.25; pointer-events: none; color: inherit; text-decoration: inherit;"><span class="op" style="color: #666666;">}</span></a></code></pre>
</div>
<p>
  <code style="white-space: pre-wrap;">d3mouse</code> - an imported
  <code style="white-space: pre-wrap;">mouse</code> function from
  <code style="white-space: pre-wrap;">d3-selection</code> - gives us
  cursor position relative to the SVG element. Two linear scales give us
  <code style="white-space: pre-wrap;">scaleFactor</code> and
  <code style="white-space: pre-wrap;">scaleLean</code> values, which we
  put into component state.
</p>
<p>
  When we feed a change to
  <code style="white-space: pre-wrap;">this.setState</code>, it triggers a
  re-render of the entire tree, our
  <code style="white-space: pre-wrap;">memoizedCalc</code> function returns
  new values, and the final result is a dancing tree.
</p>
<figure>
  <img
    src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/pythagoras-dancing.gif"
    alt="Dancing Pythagoras tree"
  />
  <figcaption>Dancing Pythagoras tree</figcaption>
</figure>
<p>Beautious. 😍</p>