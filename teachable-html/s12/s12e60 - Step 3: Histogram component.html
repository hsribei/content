<h2 id="step-3-histogram-component">Step 3: Histogram component</h2>
<p>We’re following the <a href="#full-feature-integration">full-feature integration</a> approach for our Histogram component. React talks to the DOM, D3 calculates the props.</p>
<p>We’ll use two components:</p>
<ol type="1">
<li><code>Histogram</code> makes the general layout, dealing with D3, and translating raw data into a histogram</li>
<li><code>HistogramBar</code> draws a single bar and labels it</li>
</ol>
<p>Let’s start with the basics: a <code>Histogram</code> directory and an <code>index.js</code> file. Keeps our code organized and imports easy. I like to use directories for components made of multiple files.</p>
<div class="sourceCode" id="cb77" data-caption="Re-export Histogram"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb77-1" title="1"><span class="im">export</span> <span class="op">{</span> <span class="im">default</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&quot;./Histogram&quot;</span><span class="op">;</span></a></code></pre></div>
<p>Import and re-export the histogram componenet from <code>./Histogram</code>. This way you can keep your histogram code in a file called Histogram and pretend the directory itself is exporting it.</p>
<p>Great way to group files that belong together without exposing your directory’s internal structure.</p>
<p>Now we need the <code>Histogram.js</code> file. Start with some imports, a default export, and a stubbed out <code>Histogram</code> class.</p>
<div class="sourceCode" id="cb78" data-caption="Histogram component stub"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb78-1" title="1"><span class="co">// src/components/Histogram/Histogram.js</span></a>
<a class="sourceLine" id="cb78-2" title="2"><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb78-3" title="3"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> d3 <span class="im">from</span> <span class="st">&quot;d3&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb78-4" title="4"></a>
<a class="sourceLine" id="cb78-5" title="5"><span class="kw">class</span> Histogram <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-6" title="6">    state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-7" title="7">        <span class="dt">histogram</span><span class="op">:</span> <span class="va">d3</span>.<span class="at">histogram</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb78-8" title="8">        <span class="dt">widthScale</span><span class="op">:</span> <span class="va">d3</span>.<span class="at">scaleLinear</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb78-9" title="9">        <span class="dt">yScale</span><span class="op">:</span> <span class="va">d3</span>.<span class="at">scaleLinear</span>()</a>
<a class="sourceLine" id="cb78-10" title="10">    <span class="op">};</span></a>
<a class="sourceLine" id="cb78-11" title="11"></a>
<a class="sourceLine" id="cb78-12" title="12">    <span class="kw">static</span> <span class="at">getDerivedStateFromProps</span>(props<span class="op">,</span> state) <span class="op">{</span></a>
<a class="sourceLine" id="cb78-13" title="13">        <span class="kw">let</span> <span class="op">{</span> histogram<span class="op">,</span> widthScale<span class="op">,</span> yScale <span class="op">}</span> <span class="op">=</span> state<span class="op">;</span></a>
<a class="sourceLine" id="cb78-14" title="14"></a>
<a class="sourceLine" id="cb78-15" title="15">        <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-16" title="16">            ...<span class="at">state</span><span class="op">,</span></a>
<a class="sourceLine" id="cb78-17" title="17">            histogram<span class="op">,</span></a>
<a class="sourceLine" id="cb78-18" title="18">            widthScale<span class="op">,</span></a>
<a class="sourceLine" id="cb78-19" title="19">            yScale</a>
<a class="sourceLine" id="cb78-20" title="20">        <span class="op">};</span></a>
<a class="sourceLine" id="cb78-21" title="21">    <span class="op">}</span></a>
<a class="sourceLine" id="cb78-22" title="22"></a>
<a class="sourceLine" id="cb78-23" title="23">    makeBar <span class="op">=</span> bar <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-24" title="24">        <span class="kw">const</span> <span class="op">{</span> yScale<span class="op">,</span> widthScale <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">state</span><span class="op">;</span></a>
<a class="sourceLine" id="cb78-25" title="25"></a>
<a class="sourceLine" id="cb78-26" title="26">    <span class="op">};</span></a>
<a class="sourceLine" id="cb78-27" title="27"></a>
<a class="sourceLine" id="cb78-28" title="28">    <span class="at">render</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb78-29" title="29">        <span class="kw">const</span> <span class="op">{</span> histogram<span class="op">,</span> yScale <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">state</span><span class="op">,</span></a>
<a class="sourceLine" id="cb78-30" title="30">            <span class="op">{</span> x<span class="op">,</span> y<span class="op">,</span> data<span class="op">,</span> axisMargin <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">props</span><span class="op">;</span></a>
<a class="sourceLine" id="cb78-31" title="31">            </a>
<a class="sourceLine" id="cb78-32" title="32">        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb78-33" title="33">    <span class="op">}</span></a>
<a class="sourceLine" id="cb78-34" title="34"><span class="op">}</span></a></code></pre></div>
<p>We import React and D3, and set up <code>Histogram</code>.</p>
<p>Default <code>state</code> for our D3 objects: histogram, widthScale, and yScale. An empty <code>getDerivedStateFromProps</code> to keep them updated, <code>makeBar</code> to help us render each bar, and <code>render</code> returning null for now.</p>
<h3 id="getderivedstatefromprops-1">getDerivedStateFromProps</h3>
<div class="sourceCode" id="cb79" data-caption="getDerivedStateFromProps in Histogram"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb79-1" title="1"><span class="co">// src/components/Histogram/Histogram.js</span></a>
<a class="sourceLine" id="cb79-2" title="2">    <span class="kw">static</span> <span class="at">getDerivedStateFromProps</span>(props<span class="op">,</span> state) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-3" title="3">        <span class="kw">let</span> <span class="op">{</span> histogram<span class="op">,</span> widthScale<span class="op">,</span> yScale <span class="op">}</span> <span class="op">=</span> state<span class="op">;</span></a>
<a class="sourceLine" id="cb79-4" title="4"></a>
<a class="sourceLine" id="cb79-5" title="5">        <span class="va">histogram</span>.<span class="at">thresholds</span>(<span class="va">props</span>.<span class="at">bins</span>).<span class="at">value</span>(<span class="va">props</span>.<span class="at">value</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-6" title="6"></a>
<a class="sourceLine" id="cb79-7" title="7">        <span class="kw">const</span> bars <span class="op">=</span> <span class="at">histogram</span>(<span class="va">props</span>.<span class="at">data</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb79-8" title="8">            counts <span class="op">=</span> <span class="va">bars</span>.<span class="at">map</span>(d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">length</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-9" title="9"></a>
<a class="sourceLine" id="cb79-10" title="10">        widthScale</a>
<a class="sourceLine" id="cb79-11" title="11">            .<span class="at">domain</span>([<span class="va">d3</span>.<span class="at">min</span>(counts)<span class="op">,</span> <span class="va">d3</span>.<span class="at">max</span>(counts)])</a>
<a class="sourceLine" id="cb79-12" title="12">            .<span class="at">range</span>([<span class="dv">0</span><span class="op">,</span> <span class="va">props</span>.<span class="at">width</span> <span class="op">-</span> <span class="va">props</span>.<span class="at">axisMargin</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb79-13" title="13"></a>
<a class="sourceLine" id="cb79-14" title="14">        yScale</a>
<a class="sourceLine" id="cb79-15" title="15">            .<span class="at">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="va">d3</span>.<span class="at">max</span>(bars<span class="op">,</span> d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">x1</span>)])</a>
<a class="sourceLine" id="cb79-16" title="16">            .<span class="at">range</span>([<span class="va">props</span>.<span class="at">height</span> <span class="op">-</span> <span class="va">props</span>.<span class="at">y</span> <span class="op">-</span> <span class="va">props</span>.<span class="at">bottomMargin</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb79-17" title="17"></a>
<a class="sourceLine" id="cb79-18" title="18">        <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-19" title="19">            ...<span class="at">state</span><span class="op">,</span></a>
<a class="sourceLine" id="cb79-20" title="20">            histogram<span class="op">,</span></a>
<a class="sourceLine" id="cb79-21" title="21">            widthScale<span class="op">,</span></a>
<a class="sourceLine" id="cb79-22" title="22">            yScale</a>
<a class="sourceLine" id="cb79-23" title="23">        <span class="op">};</span></a>
<a class="sourceLine" id="cb79-24" title="24">    <span class="op">}</span></a></code></pre></div>
<p>First, we configure the <code>histogram</code> generator. <code>thresholds</code> specify how many bins we want and <code>value</code> specifies the value accessor function. We get both from props passed into the <code>Histogram</code> component.</p>
<p>In our case that makes 20 bins, and the value accessor returns each data point’s <code>base_salary</code>.</p>
<p>We feed the data prop into our histogram generator, and count how many values are in each bin with a <code>.map</code> call. We need those to configure our scales.</p>
<p>If you print the result of <code>histogram()</code>, you’ll see an array structure where each entry holds metadata about the bin and the values it contains.</p>
<figure>
<img src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/histogram-data-screenshot.png" alt="console.log(this.histogram())" /><figcaption>console.log(this.histogram())</figcaption>
</figure>
<p>Let’s use this info to set up our scales.</p>
<p><code>widthScale</code> has a range from the smallest (<code>d3.min</code>) bin to the largest (<code>d3.max</code>), and a range of <code>0</code> to width less a margin. We’ll use it to calculate bar sizes.</p>
<p><code>yScale</code> has a range from <code>0</code> to the largest <code>x1</code> coordinate we can find in a bin. Bins go from <code>x0</code> to <code>x1</code>, which reflects the fact that most histograms are horizontally oriented. Ours is vertical so that our labels are easier to read. The range goes from <code>0</code> to the maximum height less a margin.</p>
<p>Now let’s render this puppy.</p>
<h3 id="render-1">render</h3>
<div class="sourceCode" id="cb80" data-caption="Histogram.render"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb80-1" title="1"><span class="co">// src/components/Histogram/Histogram.js</span></a>
<a class="sourceLine" id="cb80-2" title="2"><span class="kw">class</span> Histogram <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-3" title="3">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb80-4" title="4">    <span class="at">render</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb80-5" title="5">        <span class="kw">const</span> <span class="op">{</span> histogram<span class="op">,</span> yScale <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">state</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-6" title="6">            <span class="op">{</span> x<span class="op">,</span> y<span class="op">,</span> data<span class="op">,</span> axisMargin <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">props</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-7" title="7"></a>
<a class="sourceLine" id="cb80-8" title="8">        <span class="kw">const</span> bars <span class="op">=</span> <span class="at">histogram</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-9" title="9"></a>
<a class="sourceLine" id="cb80-10" title="10">        <span class="cf">return</span> (</a>
<a class="sourceLine" id="cb80-11" title="11">            <span class="op">&lt;</span>g className<span class="op">=</span><span class="st">&quot;histogram&quot;</span> transform<span class="op">={</span><span class="vs">`translate(</span><span class="sc">${</span>x<span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>y<span class="sc">}</span><span class="vs">)`</span><span class="op">}&gt;</span></a>
<a class="sourceLine" id="cb80-12" title="12">                <span class="op">&lt;</span>g className<span class="op">=</span><span class="st">&quot;bars&quot;</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb80-13" title="13">                    <span class="op">{</span><span class="va">bars</span>.<span class="at">map</span>(<span class="kw">this</span>.<span class="at">makeBar</span>))<span class="op">}</span></a>
<a class="sourceLine" id="cb80-14" title="14">                &lt;/g<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb80-15" title="15">            &lt;/g<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb80-16" title="16">        )<span class="op">;</span></a>
<a class="sourceLine" id="cb80-17" title="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb80-18" title="18"><span class="op">}</span></a></code></pre></div>
<p>We take everything we need out of <code>state</code> and <code>props</code> with destructuring, call <code>histogram()</code> on our data to get a list of bars, and render.</p>
<p>Our render method returns a <code>&lt;g&gt;</code> grouping element transformed to the position given in props and walks through the <code>bars</code> array, calling <code>makeBar</code> for each. Later, we’re going to add an <code>Axis</code> as well.</p>
<p>This is a great example of React’s declarativeness. We have a bunch of stuff, and all it takes to render is a loop. No worrying about how it renders, where it goes, or anything like that. Walk through data, render, done.</p>
<h3 id="makebar">makeBar</h3>
<p><code>makeBar</code> is a function that takes a histogram bar’s metadata and returns a <code>HistogramBar</code> component. We use it to make our declarative loop more readable.</p>
<div class="sourceCode" id="cb81" data-caption="Histogram.makeBar"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb81-1" title="1"><span class="co">// src/components/Histogram/Histogram.js</span></a>
<a class="sourceLine" id="cb81-2" title="2"><span class="kw">class</span> Histogram <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb81-3" title="3">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb81-4" title="4">    makeBar <span class="op">=</span> bar <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb81-5" title="5">        <span class="kw">const</span> <span class="op">{</span> yScale<span class="op">,</span> widthScale <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">state</span><span class="op">;</span></a>
<a class="sourceLine" id="cb81-6" title="6"></a>
<a class="sourceLine" id="cb81-7" title="7">        <span class="kw">let</span> percent <span class="op">=</span> (<span class="va">bar</span>.<span class="at">length</span> / <span class="kw">this</span>.<span class="va">props</span>.<span class="va">data</span>.<span class="at">length</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></a>
<a class="sourceLine" id="cb81-8" title="8"></a>
<a class="sourceLine" id="cb81-9" title="9">        <span class="kw">let</span> props <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb81-10" title="10">            <span class="dt">percent</span><span class="op">:</span> percent<span class="op">,</span></a>
<a class="sourceLine" id="cb81-11" title="11">            <span class="dt">x</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">props</span>.<span class="at">axisMargin</span><span class="op">,</span></a>
<a class="sourceLine" id="cb81-12" title="12">            <span class="dt">y</span><span class="op">:</span> <span class="at">yScale</span>(<span class="va">bar</span>.<span class="at">x1</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb81-13" title="13">            <span class="dt">width</span><span class="op">:</span> <span class="at">widthScale</span>(<span class="va">bar</span>.<span class="at">length</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb81-14" title="14">            <span class="dt">height</span><span class="op">:</span> <span class="at">yScale</span>(<span class="va">bar</span>.<span class="at">x0</span>) <span class="op">-</span> <span class="at">yScale</span>(<span class="va">bar</span>.<span class="at">x1</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb81-15" title="15">            <span class="dt">key</span><span class="op">:</span> <span class="st">&quot;histogram-bar-&quot;</span> <span class="op">+</span> <span class="va">bar</span>.<span class="at">x0</span></a>
<a class="sourceLine" id="cb81-16" title="16">        <span class="op">};</span></a>
<a class="sourceLine" id="cb81-17" title="17"></a>
<a class="sourceLine" id="cb81-18" title="18">        <span class="cf">return</span> <span class="op">&lt;</span>HistogramBar <span class="op">{</span>...<span class="at">props</span><span class="op">}</span> /&gt;<span class="op">;</span></a>
<a class="sourceLine" id="cb81-19" title="19">    <span class="op">};</span></a>
<a class="sourceLine" id="cb81-20" title="20"><span class="op">}</span></a></code></pre></div>
<p>See, we’re calculating <code>props</code> and feeding them into <code>HistogramBar</code>. Putting it in a separate function just makes the <code>.map</code> construct in <code>render</code> easier to read. There’s a lot of props to calculate.</p>
<p>Some, like <code>axisMargin</code> we pass through, others like <code>width</code> and <code>height</code> we calculate using our scales.</p>
<p>Setting the <code>key</code> prop is important. React uses it to tell the bars apart and only re-render those that change.</p>