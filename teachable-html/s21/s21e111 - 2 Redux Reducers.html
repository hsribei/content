<h2 id="redux-reducers">2 Redux Reducers</h2>
<p>With the actions firing and the drawing done, it‚Äôs time to look at the business logic of our particle generator. We‚Äôll get it done in just 33 lines of code and some change.</p>
<p>Well, it‚Äôs a bunch of change. But the 33 lines that make up <code>CREATE_PARTICLES</code> and <code>TIME_TICK</code> changes are the most interesting. The rest just flips various flags.</p>
<p>All our logic and physics goes in the reducer. <a href="http://redux.js.org/docs/basics/Reducers.html">Dan Abramov says</a> to think of reducers as the function you‚Äôd put in <code>.reduce()</code>. Given a state and a set of changes, how do I create the new state?</p>
<p>A ‚Äúsum numbers‚Äù example would look like this:</p>
<div class="sourceCode" id="cb149" data-caption="Reducer concept"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb149-1" title="1"><span class="kw">let</span> sum <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span>].<span class="at">reduce</span>((sum<span class="op">,</span> n) <span class="op">=&gt;</span> sum<span class="op">+</span>n<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></a></code></pre></div>
<p>For each number, take the previous sum and add the number.</p>
<p>Our particle generator is a more advanced version of the same concept: Takes current application state, incorporates an action, and returns new application state.</p>
<p>Start with a default state and some D3 random number helpers.</p>
<div class="sourceCode" id="cb150" data-caption="Default state and constants"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb150-1" title="1"><span class="im">import</span> <span class="op">{</span> randomNormal <span class="op">}</span> <span class="im">from</span> <span class="st">&quot;d3&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb150-2" title="2"></a>
<a class="sourceLine" id="cb150-3" title="3"><span class="kw">const</span> Gravity <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-4" title="4">    randNormal <span class="op">=</span> <span class="at">randomNormal</span>(<span class="fl">0.3</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb150-5" title="5">    randNormal2 <span class="op">=</span> <span class="at">randomNormal</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.8</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb150-6" title="6"></a>
<a class="sourceLine" id="cb150-7" title="7"><span class="kw">const</span> initialState <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb150-8" title="8">    <span class="dt">particles</span><span class="op">:</span> []<span class="op">,</span></a>
<a class="sourceLine" id="cb150-9" title="9">    <span class="dt">particleIndex</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-10" title="10">    <span class="dt">particlesPerTick</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-11" title="11">    <span class="dt">svgWidth</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-12" title="12">    <span class="dt">svgHeight</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-13" title="13">    <span class="dt">isTickerStarted</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-14" title="14">    <span class="dt">generateParticles</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb150-15" title="15">    <span class="dt">mousePos</span><span class="op">:</span> [<span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb150-16" title="16">    <span class="dt">lastFrameTime</span><span class="op">:</span> <span class="kw">null</span></a>
<a class="sourceLine" id="cb150-17" title="17"><span class="op">};</span></a></code></pre></div>
<p>Using D3‚Äôs <code>randomNormal</code> random number generator creates a better random distribution than using JavaScript‚Äôs own <code>Math.random</code>. The rest is a bunch of default state üëá</p>
<ul>
<li><code>particles</code> holds an array of particles to draw</li>
<li><code>particleIndex</code> defines the ID of the next generated particle</li>
<li><code>particlesPerTick</code> defines how many particles we create on each requestAnimationFrame</li>
<li><code>svgWidth</code> is the width of our drawing area</li>
<li><code>svgHeigh</code> is the height</li>
<li><code>isTickerStarted</code> specifies whether the animation is running</li>
<li><code>generateParticles</code> turns particle generation on and off</li>
<li><code>mousePos</code> defines the origination point for new particles</li>
<li><code>lastFrameTime</code> helps us compensate for dropped frames</li>
</ul>
<p>To manipulate all this state, we use two reducers and manually combine them. Redux does come with a <code>combineReducers</code> function, but I wanted to keep our state flat and that doesn‚Äôt fit <code>combineReducers</code>‚Äôs view of how life should work.</p>
<div class="sourceCode" id="cb151" data-caption="Combining two reducers"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb151-1" title="1"><span class="co">// src/reducers/index.js</span></a>
<a class="sourceLine" id="cb151-2" title="2"></a>
<a class="sourceLine" id="cb151-3" title="3"><span class="co">// Manually combineReducers</span></a>
<a class="sourceLine" id="cb151-4" title="4"><span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>(state <span class="op">=</span> initialState<span class="op">,</span> action) <span class="op">{</span></a>
<a class="sourceLine" id="cb151-5" title="5">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb151-6" title="6">        ...<span class="at">appReducer</span>(state<span class="op">,</span> action)<span class="op">,</span></a>
<a class="sourceLine" id="cb151-7" title="7">        ...<span class="at">particlesReducer</span>(state<span class="op">,</span> action)</a>
<a class="sourceLine" id="cb151-8" title="8">    <span class="op">};</span></a>
<a class="sourceLine" id="cb151-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>This is our reducer. It takes current <code>state</code>, sets it to <code>initialState</code> if undefined, and an action. To create new state, it spreads the object returned from <code>appReducer</code> and from <code>particlesReducer</code> into a new object. You can combine as many reducers as you want in this way.</p>
<p>The usual <code>combineReducers</code> approach leads to nested hierarchical state. That often works great, but I wanted to keep our state flat.</p>
<p>Lesson here is that there are no rules. You can make your reducers whatever you want. Combine them whichever way fits your use case. As long as you take a state object and an action and return a new state object.</p>
<p><code>appReducer</code> will handle the constants and booleans and drive the metadata for our animation. <code>particlesReducer</code> will do the hard work of generating and animating particles.</p>
<h3 id="driving-the-basics-with-appreducer">Driving the basics with appReducer</h3>
<p>Our <code>appReducer</code> handles the boring actions with a big switch statement. These are common in the Redux world. They help us decide what to do based on action type.</p>
<div class="sourceCode" id="cb152" data-caption="appReducer big switch"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb152-1" title="1"><span class="co">// src/reducers/index.js</span></a>
<a class="sourceLine" id="cb152-2" title="2"><span class="kw">function</span> <span class="at">appReducer</span>(state<span class="op">,</span> action) <span class="op">{</span></a>
<a class="sourceLine" id="cb152-3" title="3">    <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb152-4" title="4">        <span class="cf">case</span> <span class="st">&quot;TICKER_STARTED&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-5" title="5">            <span class="cf">return</span> <span class="va">Object</span>.<span class="at">assign</span>(<span class="op">{},</span> state<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-6" title="6">                <span class="dt">isTickerStarted</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb152-7" title="7">                <span class="dt">lastFrameTime</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb152-8" title="8">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-9" title="9">        <span class="cf">case</span> <span class="st">&quot;START_PARTICLES&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-10" title="10">            <span class="cf">return</span> <span class="va">Object</span>.<span class="at">assign</span>(<span class="op">{},</span> state<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-11" title="11">                <span class="dt">generateParticles</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb152-12" title="12">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-13" title="13">        <span class="cf">case</span> <span class="st">&quot;STOP_PARTICLES&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-14" title="14">            <span class="cf">return</span> <span class="va">Object</span>.<span class="at">assign</span>(<span class="op">{},</span> state<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-15" title="15">                <span class="dt">generateParticles</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb152-16" title="16">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-17" title="17">        <span class="cf">case</span> <span class="st">&quot;UPDATE_MOUSE_POS&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-18" title="18">            <span class="cf">return</span> <span class="va">Object</span>.<span class="at">assign</span>(<span class="op">{},</span> state<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-19" title="19">                <span class="dt">mousePos</span><span class="op">:</span> [<span class="va">action</span>.<span class="at">x</span><span class="op">,</span> <span class="va">action</span>.<span class="at">y</span>]</a>
<a class="sourceLine" id="cb152-20" title="20">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-21" title="21">        <span class="cf">case</span> <span class="st">&quot;RESIZE_SCREEN&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-22" title="22">            <span class="cf">return</span> <span class="va">Object</span>.<span class="at">assign</span>(<span class="op">{},</span> state<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-23" title="23">                <span class="dt">svgWidth</span><span class="op">:</span> <span class="va">action</span>.<span class="at">width</span><span class="op">,</span></a>
<a class="sourceLine" id="cb152-24" title="24">                <span class="dt">svgHeight</span><span class="op">:</span> <span class="va">action</span>.<span class="at">height</span></a>
<a class="sourceLine" id="cb152-25" title="25">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-26" title="26">        <span class="dt">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb152-27" title="27">            <span class="cf">return</span> state<span class="op">;</span></a>
<a class="sourceLine" id="cb152-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb152-29" title="29"><span class="op">}</span></a></code></pre></div>
<p>Gotta love that boilerplate üòõ</p>
<p>Even though we‚Äôre only changing values of boolean flags and two-digit arrays, <em>we have to create a new state</em>. Redux relies on application state being immutable.</p>
<p>Well, JavaScript doesn‚Äôt have real immutability. We pretend and make sure to never change state without making a new copy first. There are libraries that give you proper immutable data structures, but that‚Äôs a whole different course.</p>
<p>We use <code>Object.assign({}, ...</code> to create a new empty object, fill it with the current state, then overwrite specific values with new ones. This is fast enough even with large state trees thanks to modern JavaScript engines.</p>
<p>Note that when a reducer doesn‚Äôt recognize an action, it has to return the same state it received. Otherwise you end up wiping state. üòÖ</p>
<p>So that‚Äôs the boilerplatey state updates. Manages starting and stopping the animation, flipping the particle generation switch, and resizing our viewport.</p>
<p>The fun stuff happens in <code>particleReducer</code>.</p>
<h3 id="driving-particles-with-particlereducer">Driving particles with particleReducer</h3>
<p>Our particles live in an array. Each particle has an id, a position, and a vector. That tells us where to draw the particle and how to move it to its future position.</p>
<p>On each tick of the animation we have to:</p>
<ol type="1">
<li>Generate new particles</li>
<li>Remove particles outside the viewport</li>
<li>Move every particle by its vector</li>
</ol>
<p>We can do all that in one big reducer, like this:</p>
<div class="sourceCode" id="cb153" data-caption="The particles logic"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb153-1" title="1"><span class="co">// src/reducers/index.js</span></a>
<a class="sourceLine" id="cb153-2" title="2"><span class="kw">function</span> <span class="at">particlesReducer</span>(state<span class="op">,</span> action) <span class="op">{</span></a>
<a class="sourceLine" id="cb153-3" title="3">    <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb153-4" title="4">        <span class="cf">case</span> <span class="st">&quot;TIME_TICK&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb153-5" title="5">            <span class="kw">let</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-6" title="6">                    svgWidth<span class="op">,</span></a>
<a class="sourceLine" id="cb153-7" title="7">                    svgHeight<span class="op">,</span></a>
<a class="sourceLine" id="cb153-8" title="8">                    lastFrameTime<span class="op">,</span></a>
<a class="sourceLine" id="cb153-9" title="9">                    generateParticles<span class="op">,</span></a>
<a class="sourceLine" id="cb153-10" title="10">                    particlesPerTick<span class="op">,</span></a>
<a class="sourceLine" id="cb153-11" title="11">                    particleIndex<span class="op">,</span></a>
<a class="sourceLine" id="cb153-12" title="12">                    mousePos</a>
<a class="sourceLine" id="cb153-13" title="13">                <span class="op">}</span> <span class="op">=</span> state<span class="op">,</span></a>
<a class="sourceLine" id="cb153-14" title="14">                newFrameTime <span class="op">=</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb153-15" title="15">                multiplier <span class="op">=</span> (newFrameTime <span class="op">-</span> lastFrameTime) / (<span class="dv">1000</span> / <span class="dv">60</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb153-16" title="16">                newParticles <span class="op">=</span> <span class="va">state</span>.<span class="va">particles</span>.<span class="at">slice</span>(<span class="dv">0</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-17" title="17"></a>
<a class="sourceLine" id="cb153-18" title="18">            <span class="cf">if</span> (generateParticles) <span class="op">{</span></a>
<a class="sourceLine" id="cb153-19" title="19">                <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> particlesPerTick<span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb153-20" title="20">                    <span class="kw">let</span> particle <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-21" title="21">                        <span class="dt">id</span><span class="op">:</span> <span class="va">state</span>.<span class="at">particleIndex</span> <span class="op">+</span> i<span class="op">,</span></a>
<a class="sourceLine" id="cb153-22" title="22">                        <span class="dt">x</span><span class="op">:</span> mousePos[<span class="dv">0</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb153-23" title="23">                        <span class="dt">y</span><span class="op">:</span> mousePos[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb153-24" title="24">                    <span class="op">};</span></a>
<a class="sourceLine" id="cb153-25" title="25"></a>
<a class="sourceLine" id="cb153-26" title="26">                    <span class="va">particle</span>.<span class="at">vector</span> <span class="op">=</span> [</a>
<a class="sourceLine" id="cb153-27" title="27">                        <span class="va">particle</span>.<span class="at">id</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">?</span> <span class="op">-</span><span class="at">randNormal</span>() : <span class="at">randNormal</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb153-28" title="28">                        <span class="op">-</span><span class="at">randNormal2</span>() <span class="op">*</span> <span class="fl">3.3</span></a>
<a class="sourceLine" id="cb153-29" title="29">                    ]<span class="op">;</span></a>
<a class="sourceLine" id="cb153-30" title="30"></a>
<a class="sourceLine" id="cb153-31" title="31">                    <span class="va">newParticles</span>.<span class="at">unshift</span>(particle)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-32" title="32">                <span class="op">}</span></a>
<a class="sourceLine" id="cb153-33" title="33"></a>
<a class="sourceLine" id="cb153-34" title="34">                particleIndex <span class="op">=</span> particleIndex <span class="op">+</span> particlesPerTick <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb153-35" title="35">            <span class="op">}</span></a>
<a class="sourceLine" id="cb153-36" title="36"></a>
<a class="sourceLine" id="cb153-37" title="37">            <span class="kw">let</span> movedParticles <span class="op">=</span> newParticles</a>
<a class="sourceLine" id="cb153-38" title="38">                .<span class="at">filter</span>(p <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-39" title="39">                    <span class="cf">return</span> <span class="op">!</span>(<span class="va">p</span>.<span class="at">y</span> <span class="op">&gt;</span> svgHeight <span class="op">||</span> <span class="va">p</span>.<span class="at">x</span> <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> <span class="va">p</span>.<span class="at">x</span> <span class="op">&gt;</span> svgWidth)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-40" title="40">                <span class="op">}</span>)</a>
<a class="sourceLine" id="cb153-41" title="41">                .<span class="at">map</span>(p <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-42" title="42">                    <span class="kw">let</span> [vx<span class="op">,</span> vy] <span class="op">=</span> <span class="va">p</span>.<span class="at">vector</span><span class="op">;</span></a>
<a class="sourceLine" id="cb153-43" title="43">                    <span class="va">p</span>.<span class="at">x</span> <span class="op">+=</span> vx <span class="op">*</span> multiplier<span class="op">;</span></a>
<a class="sourceLine" id="cb153-44" title="44">                    <span class="va">p</span>.<span class="at">y</span> <span class="op">+=</span> vy <span class="op">*</span> multiplier<span class="op">;</span></a>
<a class="sourceLine" id="cb153-45" title="45">                    <span class="va">p</span>.<span class="at">vector</span>[<span class="dv">1</span>] <span class="op">+=</span> Gravity <span class="op">*</span> multiplier<span class="op">;</span></a>
<a class="sourceLine" id="cb153-46" title="46">                    <span class="cf">return</span> p<span class="op">;</span></a>
<a class="sourceLine" id="cb153-47" title="47">                <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-48" title="48"></a>
<a class="sourceLine" id="cb153-49" title="49">            <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-50" title="50">                <span class="dt">particles</span><span class="op">:</span> movedParticles<span class="op">,</span></a>
<a class="sourceLine" id="cb153-51" title="51">                <span class="dt">lastFrameTime</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb153-52" title="52">                particleIndex</a>
<a class="sourceLine" id="cb153-53" title="53">            <span class="op">};</span></a>
<a class="sourceLine" id="cb153-54" title="54">        <span class="dt">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb153-55" title="55">            <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-56" title="56">                <span class="dt">particles</span><span class="op">:</span> <span class="va">state</span>.<span class="at">particles</span><span class="op">,</span></a>
<a class="sourceLine" id="cb153-57" title="57">                <span class="dt">lastFrameTime</span><span class="op">:</span> <span class="va">state</span>.<span class="at">lastFrameTime</span><span class="op">,</span></a>
<a class="sourceLine" id="cb153-58" title="58">                <span class="dt">particleIndex</span><span class="op">:</span> <span class="va">state</span>.<span class="at">particleIndex</span></a>
<a class="sourceLine" id="cb153-59" title="59">            <span class="op">};</span></a>
<a class="sourceLine" id="cb153-60" title="60">    <span class="op">}</span></a>
<a class="sourceLine" id="cb153-61" title="61"><span class="op">}</span></a></code></pre></div>
<p>That‚Äôs a lot of code, I know. Let me explain :)</p>
<p>The first part takes important values out of <code>state</code>, calculates the dropped frame multiplier, and makes a new copy of the particles array with <code>.slice(0)</code>. That was the fastest way I could find.</p>
<p>Then we generate new particles.</p>
<p>We loop through <code>particlesPerTick</code> particles, create them at <code>mousePos</code> coordinates, and insert at the beginning of the array. In my tests that performed best. Particles get random movement vectors.</p>
<p>This randomness is a Redux faux pas. Reducers are supposed to be functionally pure: produce the same result every time they are called with the same argument values. Randomness is impure.</p>
<p>We don‚Äôt need our particle vectors to be deterministic, so I think this is fine. Let‚Äôs say our universe is stochastic instead :smile:</p>
<p>{aside} Stochastic means that our universe/physic simulation is governed by probabilities. You can still model such a universe and reason about its behavior. A lot of real world physics is stochastic in nature. {/aside}</p>
<p>We now have an array full of old and new particles. We remove all out-of-bounds particles with a <code>filter</code>, then walk through what‚Äôs left to move each particle by its vector.</p>
<p>To simulate gravity, we update vectors‚Äô vertical component using our <code>Gravity</code> constant. That makes particles fall down faster and faster creating a nice parabola.</p>
<p>Our reducer is done. Our particle generator works. Our thing animates smoothly. /</p>