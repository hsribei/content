<h2 id="step-1-update-app.js">Step 1: Update App.js</h2>
<p>All right, you know the drill. Add imports, tweak some things, add to render. We have to import <code>Controls</code>, set up filtering, update the map’s <code>zoom</code> prop, and render a white rectangle and <code>Controls</code>.</p>
<p>The white rectangle makes it so the zoomed-in map doesn’t cover up the histogram. I’ll explain when we get there.</p>
<div class="sourceCode" id="cb101" data-caption="Imports and filter updates in App.js"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb101-1" title="1"><span class="co">// src/App.js</span></a>
<a class="sourceLine" id="cb101-2" title="2"><span class="im">import</span> MedianLine <span class="im">from</span> <span class="st">&#39;./components/MedianLine&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb101-3" title="3"></a>
<a class="sourceLine" id="cb101-4" title="4"><span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb101-5" title="5"><span class="im">import</span> Controls <span class="im">from</span> <span class="st">&#39;./components/Controls&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb101-6" title="6"><span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb101-7" title="7"></a>
<a class="sourceLine" id="cb101-8" title="8"><span class="kw">class</span> App <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-9" title="9">    state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-10" title="10">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb101-11" title="11">        <span class="dt">medianIncomes</span><span class="op">:</span> []<span class="op">,</span></a>
<a class="sourceLine" id="cb101-12" title="12">        <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb101-13" title="13">        <span class="dt">salariesFilter</span><span class="op">:</span> () <span class="op">=&gt;</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb101-14" title="14">        <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb101-15" title="15">        <span class="dt">filteredBy</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-16" title="16">            <span class="co">// ...</span></a>
<a class="sourceLine" id="cb101-17" title="17">        <span class="op">}</span></a>
<a class="sourceLine" id="cb101-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb101-19" title="19"></a>
<a class="sourceLine" id="cb101-20" title="20">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb101-21" title="21"></a>
<a class="sourceLine" id="cb101-22" title="22">    <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb101-23" title="23">    updateDataFilter <span class="op">=</span> (filter<span class="op">,</span> filteredBy) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-24" title="24">        <span class="kw">this</span>.<span class="at">setState</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb101-25" title="25">            <span class="dt">salariesFilter</span><span class="op">:</span> filter<span class="op">,</span></a>
<a class="sourceLine" id="cb101-26" title="26">            <span class="dt">filteredBy</span><span class="op">:</span> filteredBy</a>
<a class="sourceLine" id="cb101-27" title="27">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb101-29" title="29">    <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb101-30" title="30"></a>
<a class="sourceLine" id="cb101-31" title="31">    <span class="at">render</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb101-32" title="32">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb101-33" title="33">    <span class="op">}</span></a>
<a class="sourceLine" id="cb101-34" title="34"><span class="op">}</span></a></code></pre></div>
<p>We import the <code>Controls</code> component and add a default <code>salariesFilter</code> function to <code>this.state</code>. The <code>updateDataFilter</code> method passes the filter function and <code>filteredBy</code> dictionary from arguments to App state. We’ll use it as a callback in <code>Controls</code>.</p>
<p>The rest of filtering setup happens in the render method.</p>
<div class="sourceCode" id="cb102" data-caption="Filtering data and updating map zoom in App render"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb102-1" title="1"><span class="co">// src/App.js</span></a>
<a class="sourceLine" id="cb102-2" title="2"><span class="kw">class</span> App <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb102-3" title="3">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb102-4" title="4"></a>
<a class="sourceLine" id="cb102-5" title="5">    <span class="at">render</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb102-6" title="6">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb102-7" title="7">        <span class="co">// markua-start-delete</span></a>
<a class="sourceLine" id="cb102-8" title="8">        <span class="kw">const</span> filteredSalaries <span class="op">=</span> techSalaries</a>
<a class="sourceLine" id="cb102-9" title="9">        <span class="co">// markua-end-delete</span></a>
<a class="sourceLine" id="cb102-10" title="10">        <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb102-11" title="11">        <span class="kw">const</span> filteredSalaries <span class="op">=</span> techSalaries</a>
<a class="sourceLine" id="cb102-12" title="12">                                     .<span class="at">filter</span>(<span class="kw">this</span>.<span class="va">state</span>.<span class="at">salariesFilter</span>)</a>
<a class="sourceLine" id="cb102-13" title="13">        <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb102-14" title="14"></a>
<a class="sourceLine" id="cb102-15" title="15">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb102-16" title="16"></a>
<a class="sourceLine" id="cb102-17" title="17">        <span class="kw">let</span> zoom <span class="op">=</span> <span class="kw">null</span><span class="op">,</span></a>
<a class="sourceLine" id="cb102-18" title="18">            medianHousehold <span class="op">=</span> <span class="co">// ...</span></a>
<a class="sourceLine" id="cb102-19" title="19">        <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb102-20" title="20">        <span class="cf">if</span> (<span class="va">filteredBy</span>.<span class="at">USstate</span> <span class="op">!==</span> <span class="st">&#39;*&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb102-21" title="21">            zoom <span class="op">=</span> <span class="kw">this</span>.<span class="va">state</span>.<span class="va">filteredBy</span>.<span class="at">USstate</span><span class="op">;</span></a>
<a class="sourceLine" id="cb102-22" title="22">            medianHousehold <span class="op">=</span> <span class="va">d3</span>.<span class="at">mean</span>(medianIncomesByUSState[zoom]<span class="op">,</span></a>
<a class="sourceLine" id="cb102-23" title="23">                                      d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">medianIncome</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb102-24" title="24">        <span class="op">}</span></a>
<a class="sourceLine" id="cb102-25" title="25">        <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb102-26" title="26"></a>
<a class="sourceLine" id="cb102-27" title="27">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb102-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb102-29" title="29"><span class="op">}</span></a></code></pre></div>
<p>We add a <code>.filter</code> call to <code>filteredSalaries</code>, which uses our <code>salariesFilter</code> method to throw out anything that doesn’t fit. Then we set up <code>zoom</code>, if a US state was selected.</p>
<p>We built the <code>CountyMap</code> component to focus on a given US state. Finding the centroid of a polygon, re-centering the map, and increasing the sizing factor. It creates a nice zoom effect.</p>
<figure>
<img src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/zoom-effect.png" alt="Zoom effect" /><figcaption>Zoom effect</figcaption>
</figure>
<p>And here’s the downside of this approach. SVG doesn’t know about element boundaries. It just renders stuff.</p>
<figure>
<img src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/es6v2/zoom-without-rectangle.png" alt="Zoom without white rectangle" /><figcaption>Zoom without white rectangle</figcaption>
</figure>
<p>See, it goes under the histogram. Let’s fix that and add the <code>Controls</code> render while we’re at it.</p>
<div class="sourceCode" id="cb103" data-caption="Add opaque background to histogram"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb103-1" title="1"><span class="co">// src/App.js</span></a>
<a class="sourceLine" id="cb103-2" title="2"><span class="kw">class</span> App <span class="kw">extends</span> <span class="va">React</span>.<span class="at">Component</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb103-3" title="3">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb103-4" title="4"></a>
<a class="sourceLine" id="cb103-5" title="5">    <span class="at">render</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb103-6" title="6">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb103-7" title="7"></a>
<a class="sourceLine" id="cb103-8" title="8">        <span class="cf">return</span> (</a>
<a class="sourceLine" id="cb103-9" title="9">            <span class="op">&lt;</span>div <span class="co">//...&gt;</span></a>
<a class="sourceLine" id="cb103-10" title="10">                <span class="op">&lt;</span>svg <span class="co">//...&gt;</span></a>
<a class="sourceLine" id="cb103-11" title="11">                    <span class="op">&lt;</span>CountyMap <span class="co">//... /&gt;</span></a>
<a class="sourceLine" id="cb103-12" title="12"></a>
<a class="sourceLine" id="cb103-13" title="13">                    <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb103-14" title="14">                    <span class="op">&lt;</span>rect x<span class="op">=</span><span class="st">&quot;500&quot;</span> y<span class="op">=</span><span class="st">&quot;0&quot;</span></a>
<a class="sourceLine" id="cb103-15" title="15">                          width<span class="op">=</span><span class="st">&quot;600&quot;</span></a>
<a class="sourceLine" id="cb103-16" title="16">                          height<span class="op">=</span><span class="st">&quot;500&quot;</span></a>
<a class="sourceLine" id="cb103-17" title="17">                          style<span class="op">={{</span><span class="dt">fill</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">}}</span> /&gt;</a>
<a class="sourceLine" id="cb103-18" title="18">                    <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb103-19" title="19"></a>
<a class="sourceLine" id="cb103-20" title="20">                    <span class="op">&lt;</span>Histogram <span class="co">//... /&gt;</span></a>
<a class="sourceLine" id="cb103-21" title="21">                    <span class="op">&lt;</span>MedianLine <span class="co">//.. /&gt;</span></a>
<a class="sourceLine" id="cb103-22" title="22">                &lt;/svg<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb103-23" title="23"></a>
<a class="sourceLine" id="cb103-24" title="24">                <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb103-25" title="25">                <span class="op">&lt;</span>Controls data<span class="op">={</span>techSalaries<span class="op">}</span></a>
<a class="sourceLine" id="cb103-26" title="26">                          updateDataFilter<span class="op">={</span><span class="kw">this</span>.<span class="at">updateDataFilter</span><span class="op">}</span> /&gt;</a>
<a class="sourceLine" id="cb103-27" title="27">                <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb103-28" title="28">            &lt;/div<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb103-29" title="29">        )</a>
<a class="sourceLine" id="cb103-30" title="30">    <span class="op">}</span></a>
<a class="sourceLine" id="cb103-31" title="31"><span class="op">}</span></a></code></pre></div>
<p>Rectangle, <code>500</code> to the right, <code>0</code> from top, <code>600</code> wide and <code>500</code> tall, with a white background. Gives the histogram an opaque background, so it doesn’t matter what the map is doing.</p>
<p>We render the <code>Controls</code> component just after <code>&lt;/svg&gt;</code> because it’s not an SVG component – it uses normal HTML. Unlike other components, it needs our entire dataset as <code>data</code>. We use the <code>updateDataFilter</code> prop to say which callback function it should call when a new filter is ready.</p>
<p>If this seems roundabout … I’ve seen worse. The callbacks approach makes our app easier to componentize and keeps the code relatively unmessy. Imagine putting everything we’ve done so far in <code>App</code>! :laughing:</p>