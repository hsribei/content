<h2 id="magic-trick">D3blackbox magic trick – render anything in 30 seconds</h2>
<p>Let me show you a magic trick. 30 seconds to take a random D3 piece of code and add it to your React project.</p>
<p>We can try it on the example barchart from before.</p>
<figure>
<img src="https://raw.githubusercontent.com/Swizec/react-d3js-es6-ebook/2018-version/manuscript/resources/images/2018/barchart-example.png" alt="An example D3 barchart" /><figcaption>An example D3 barchart</figcaption>
</figure>
<p>You can <a href="https://cdn.rawgit.com/mbostock/3885304/raw/a91f37f5f4b43269df3dbabcda0090310c05285d/index.html">try it online</a>. When you hover on a bar, it changes color. Pretty neat.</p>
<p>I recommend you follow along in a CodeSandbox. If you fork the <a href="https://codesandbox.io/s/5v21r0wo4x">react-d3-axis-hoc CodeSandbox</a> that will be easiest.</p>
<iframe src="https://codesandbox.io/embed/5v21r0wo4x?codemirror=1&amp;view=split" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>
<p>You should already have the <code>D3blackbox</code> HOC. If you don’t, make a new file and paste it in.</p>
<p>With your HOC ready, create a new file in CodeSandbox. Call it <code>Barchart.js</code>.</p>
<p>Add your imports:</p>
<div class="sourceCode" id="cb25" data-caption="Import dependencies"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="im">import</span> D3blackbox <span class="im">from</span> <span class="st">&#39;./D3blackbox&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> d3 <span class="im">from</span> <span class="st">&#39;d3&#39;</span><span class="op">;</span></a></code></pre></div>
<p>This gives you React, our HOC, and D3.</p>
<p>Now right-click view code on that barchart and copy the code. Wrap it in a <code>D3blackbox</code> call. Like this:</p>
<div class="sourceCode" id="cb26" data-caption="Wrap D3 code in D3blackbox"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">const</span> Barchart <span class="op">=</span> <span class="at">D3blackbox</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb26-2" title="2">    <span class="kw">var</span> svg <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="st">&quot;svg&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb26-3" title="3">        margin <span class="op">=</span> <span class="op">{</span><span class="dt">top</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">40</span><span class="op">},</span></a>
<a class="sourceLine" id="cb26-4" title="4">        width <span class="op">=</span> <span class="op">+</span><span class="va">svg</span>.<span class="at">attr</span>(<span class="st">&quot;width&quot;</span>) <span class="op">-</span> <span class="va">margin</span>.<span class="at">left</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">right</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-5" title="5">        height <span class="op">=</span> <span class="op">+</span><span class="va">svg</span>.<span class="at">attr</span>(<span class="st">&quot;height&quot;</span>) <span class="op">-</span> <span class="va">margin</span>.<span class="at">top</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">bottom</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-6" title="6">    </a>
<a class="sourceLine" id="cb26-7" title="7">    <span class="kw">var</span> x <span class="op">=</span> <span class="va">d3</span>.<span class="at">scaleBand</span>().<span class="at">rangeRound</span>([<span class="dv">0</span><span class="op">,</span> width]).<span class="at">padding</span>(<span class="fl">0.1</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb26-8" title="8">        y <span class="op">=</span> <span class="va">d3</span>.<span class="at">scaleLinear</span>().<span class="at">rangeRound</span>([height<span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb26-9" title="9">    </a>
<a class="sourceLine" id="cb26-10" title="10">    <span class="kw">var</span> g <span class="op">=</span> <span class="va">svg</span>.<span class="at">append</span>(<span class="st">&quot;g&quot;</span>)</a>
<a class="sourceLine" id="cb26-11" title="11">        .<span class="at">attr</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="st">&quot;translate(&quot;</span> <span class="op">+</span> <span class="va">margin</span>.<span class="at">left</span> <span class="op">+</span> <span class="st">&quot;,&quot;</span> <span class="op">+</span> <span class="va">margin</span>.<span class="at">top</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-12" title="12">    </a>
<a class="sourceLine" id="cb26-13" title="13">    <span class="va">d3</span>.<span class="at">tsv</span>(<span class="st">&quot;data.tsv&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-14" title="14">      <span class="va">d</span>.<span class="at">frequency</span> <span class="op">=</span> <span class="op">+</span><span class="va">d</span>.<span class="at">frequency</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-15" title="15">      <span class="cf">return</span> d<span class="op">;</span></a>
<a class="sourceLine" id="cb26-16" title="16">    <span class="op">},</span> <span class="kw">function</span>(error<span class="op">,</span> data) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-17" title="17">      <span class="cf">if</span> (error) <span class="cf">throw</span> error<span class="op">;</span></a>
<a class="sourceLine" id="cb26-18" title="18">    </a>
<a class="sourceLine" id="cb26-19" title="19">      <span class="va">x</span>.<span class="at">domain</span>(<span class="va">data</span>.<span class="at">map</span>(<span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="va">d</span>.<span class="at">letter</span><span class="op">;</span> <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb26-20" title="20">      <span class="va">y</span>.<span class="at">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="va">d3</span>.<span class="at">max</span>(data<span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="va">d</span>.<span class="at">frequency</span><span class="op">;</span> <span class="op">}</span>)])<span class="op">;</span></a>
<a class="sourceLine" id="cb26-21" title="21">    </a>
<a class="sourceLine" id="cb26-22" title="22">      <span class="va">g</span>.<span class="at">append</span>(<span class="st">&quot;g&quot;</span>)</a>
<a class="sourceLine" id="cb26-23" title="23">          .<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span> <span class="st">&quot;axis axis--x&quot;</span>)</a>
<a class="sourceLine" id="cb26-24" title="24">          .<span class="at">attr</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="st">&quot;translate(0,&quot;</span> <span class="op">+</span> height <span class="op">+</span> <span class="st">&quot;)&quot;</span>)</a>
<a class="sourceLine" id="cb26-25" title="25">          .<span class="at">call</span>(<span class="va">d3</span>.<span class="at">axisBottom</span>(x))<span class="op">;</span></a>
<a class="sourceLine" id="cb26-26" title="26">    </a>
<a class="sourceLine" id="cb26-27" title="27">      <span class="va">g</span>.<span class="at">append</span>(<span class="st">&quot;g&quot;</span>)</a>
<a class="sourceLine" id="cb26-28" title="28">          .<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span> <span class="st">&quot;axis axis--y&quot;</span>)</a>
<a class="sourceLine" id="cb26-29" title="29">          .<span class="at">call</span>(<span class="va">d3</span>.<span class="at">axisLeft</span>(y).<span class="at">ticks</span>(<span class="dv">10</span><span class="op">,</span> <span class="st">&quot;%&quot;</span>))</a>
<a class="sourceLine" id="cb26-30" title="30">        .<span class="at">append</span>(<span class="st">&quot;text&quot;</span>)</a>
<a class="sourceLine" id="cb26-31" title="31">          .<span class="at">attr</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="st">&quot;rotate(-90)&quot;</span>)</a>
<a class="sourceLine" id="cb26-32" title="32">          .<span class="at">attr</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb26-33" title="33">          .<span class="at">attr</span>(<span class="st">&quot;dy&quot;</span><span class="op">,</span> <span class="st">&quot;0.71em&quot;</span>)</a>
<a class="sourceLine" id="cb26-34" title="34">          .<span class="at">attr</span>(<span class="st">&quot;text-anchor&quot;</span><span class="op">,</span> <span class="st">&quot;end&quot;</span>)</a>
<a class="sourceLine" id="cb26-35" title="35">          .<span class="at">text</span>(<span class="st">&quot;Frequency&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-36" title="36">    </a>
<a class="sourceLine" id="cb26-37" title="37">      <span class="va">g</span>.<span class="at">selectAll</span>(<span class="st">&quot;.bar&quot;</span>)</a>
<a class="sourceLine" id="cb26-38" title="38">        .<span class="at">data</span>(data)</a>
<a class="sourceLine" id="cb26-39" title="39">        .<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&quot;rect&quot;</span>)</a>
<a class="sourceLine" id="cb26-40" title="40">          .<span class="at">attr</span>(<span class="st">&quot;class&quot;</span><span class="op">,</span> <span class="st">&quot;bar&quot;</span>)</a>
<a class="sourceLine" id="cb26-41" title="41">          .<span class="at">attr</span>(<span class="st">&quot;x&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">x</span>(<span class="va">d</span>.<span class="at">letter</span>)<span class="op">;</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-42" title="42">          .<span class="at">attr</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> <span class="at">y</span>(<span class="va">d</span>.<span class="at">frequency</span>)<span class="op">;</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-43" title="43">          .<span class="at">attr</span>(<span class="st">&quot;width&quot;</span><span class="op">,</span> <span class="va">x</span>.<span class="at">bandwidth</span>())</a>
<a class="sourceLine" id="cb26-44" title="44">          .<span class="at">attr</span>(<span class="st">&quot;height&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span> <span class="cf">return</span> height <span class="op">-</span> <span class="at">y</span>(<span class="va">d</span>.<span class="at">frequency</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-45" title="45">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-46" title="46"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-47" title="47"></a>
<a class="sourceLine" id="cb26-48" title="48"><span class="im">export</span> <span class="im">default</span> Barchart<span class="op">;</span></a></code></pre></div>
<p>That should throw some errors. We have to change the <code>d3.select</code> and get <code>width</code> and <code>height</code> from props.</p>
<div class="sourceCode" id="cb27" data-caption="Change where D3 renders"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">const</span> Barchart <span class="op">=</span> <span class="at">D3blackbox</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb27-2" title="2">  <span class="co">// markua-start-delete</span></a>
<a class="sourceLine" id="cb27-3" title="3">    <span class="kw">var</span> svg <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="st">&quot;svg&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb27-4" title="4">  <span class="co">// markua-end-delete</span></a>
<a class="sourceLine" id="cb27-5" title="5">  <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb27-6" title="6">  <span class="kw">var</span> svg <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="kw">this</span>.<span class="va">anchor</span>.<span class="at">current</span>)</a>
<a class="sourceLine" id="cb27-7" title="7">  <span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb27-8" title="8">        margin <span class="op">=</span> <span class="op">{</span><span class="dt">top</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">40</span><span class="op">},</span></a>
<a class="sourceLine" id="cb27-9" title="9">        <span class="co">// markua-start-delete</span></a>
<a class="sourceLine" id="cb27-10" title="10">        width <span class="op">=</span> <span class="op">+</span><span class="va">svg</span>.<span class="at">attr</span>(<span class="st">&quot;width&quot;</span>) <span class="op">-</span> <span class="va">margin</span>.<span class="at">left</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">right</span><span class="op">,</span></a>
<a class="sourceLine" id="cb27-11" title="11">        height <span class="op">=</span> <span class="op">+</span><span class="va">svg</span>.<span class="at">attr</span>(<span class="st">&quot;height&quot;</span>) <span class="op">-</span> <span class="va">margin</span>.<span class="at">top</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">bottom</span><span class="op">;</span></a>
<a class="sourceLine" id="cb27-12" title="12">        <span class="co">// markua-end-delete</span></a>
<a class="sourceLine" id="cb27-13" title="13">        <span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb27-14" title="14">        width <span class="op">=</span> <span class="op">+</span><span class="kw">this</span>.<span class="va">props</span>.<span class="at">width</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">left</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">right</span><span class="op">,</span></a>
<a class="sourceLine" id="cb27-15" title="15">        height <span class="op">=</span> <span class="op">+</span><span class="kw">this</span>.<span class="va">props</span>.<span class="at">height</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">top</span> <span class="op">-</span> <span class="va">margin</span>.<span class="at">bottom</span><span class="op">;</span></a>
<a class="sourceLine" id="cb27-16" title="16">        <span class="co">// markua-end-insert</span></a></code></pre></div>
<p>Most D3 examples use a global <code>svg</code> variable to refer to their drawing area – the SVG. Change that to the element you want, your anchor, and the whole visualization should render in there.</p>
<p>We also replaced reading width and height from the SVG element to getting them from props. This makes our component more reusable and better follows best practices.</p>
<p>Next step is to change where our barchart gets its data. Gotta use the public URL.</p>
<div class="sourceCode" id="cb28" data-caption="Change data URL"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="co">//markua-start-delete</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="va">d3</span>.<span class="at">tsv</span>(<span class="st">&quot;data.tsv&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="co">// markua-end-delete</span></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="va">d3</span>.<span class="at">tsv</span>(<span class="st">&quot;https://cdn.rawgit.com/mbostock/3885304/raw/a91f37f5f4b43269df3dbabcda0090310c05285d/data.tsv&quot;</span><span class="op">,</span> <span class="kw">function</span>(d) <span class="op">{</span></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="co">// markua-end-insert</span></a>
<a class="sourceLine" id="cb28-7" title="7">      <span class="va">d</span>.<span class="at">frequency</span> <span class="op">=</span> <span class="op">+</span><span class="va">d</span>.<span class="at">frequency</span><span class="op">;</span></a>
<a class="sourceLine" id="cb28-8" title="8">      <span class="cf">return</span> d<span class="op">;</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">// markua-start-delete</span></a>
<a class="sourceLine" id="cb28-10" title="10">    <span class="op">},</span> <span class="kw">function</span>(error<span class="op">,</span> data) <span class="op">{</span></a>
<a class="sourceLine" id="cb28-11" title="11">      <span class="cf">if</span> (error) <span class="cf">throw</span> error<span class="op">;</span></a>
<a class="sourceLine" id="cb28-12" title="12"><span class="co">// markua-end-delete</span></a>
<a class="sourceLine" id="cb28-13" title="13"><span class="co">// markua-start-insert</span></a>
<a class="sourceLine" id="cb28-14" title="14">    <span class="op">}</span>).<span class="at">then</span>(<span class="kw">function</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="co">// markua-end-insert</span></a></code></pre></div>
<p>Same link, absolute version. And we updated the callback-based code to use the D3v5 promises version. That’s the most disruptive change going from v4 to v5 I believe.</p>
<p>That’s it. You now have a Barchart component that renders the example barchart from D3’s docs.</p>
<p>You can use it like this 👇 I recommend adding this code to the main App component that CodeSandbox creates for you.</p>
<div class="sourceCode" id="cb29" data-caption="Use the Barchart"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" title="1"><span class="im">import</span> Barchart <span class="im">from</span> <span class="st">&#39;./Barchart&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-2" title="2"></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="co">// ...</span></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="cf">return</span> (</a>
<a class="sourceLine" id="cb29-5" title="5">    <span class="op">&lt;</span>svg width<span class="op">=</span><span class="st">&quot;800&quot;</span> height<span class="op">=</span><span class="st">&quot;600&quot;</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb29-6" title="6">        <span class="op">&lt;</span>Barchart x<span class="op">={</span><span class="dv">10</span><span class="op">}</span> y<span class="op">={</span><span class="dv">10</span><span class="op">}</span> width<span class="op">={</span><span class="dv">400</span><span class="op">}</span> height<span class="op">={</span><span class="dv">300</span><span class="op">}</span> /&gt;</a>
<a class="sourceLine" id="cb29-7" title="7">    &lt;/svg<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb29-8" title="8">)</a></code></pre></div>
<p>But like I said, don’t use this in production. It’s great for quick prototypes, trying stuff out, or seeing how an existing visualization might fit your app.</p>