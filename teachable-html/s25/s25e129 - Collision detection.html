<h4 id="simulationstep-where-collisions-collision">simulationStep ‚Äì¬†where collisions collision</h4>
<p>Here comes the fun part. The one with our game loop.</p>
<p>There‚Äôs also a video explaining how this works üëâ <a href="https://www.youtube.com/watch?v=H84fmXjTElM">Watch it on YouTube</a>. With hand-drawn sketches that explain the math, and I think that‚Äôs neat.</p>
<div class="sourceCode" id="cb175" data-caption="Full simulationStep function"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb175-1" title="1"></a>
<a class="sourceLine" id="cb175-2" title="2">@action <span class="at">simulationStep</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb175-3" title="3">    <span class="kw">const</span> <span class="op">{</span> width<span class="op">,</span> height<span class="op">,</span> MarbleR <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-4" title="4"></a>
<a class="sourceLine" id="cb175-5" title="5">    <span class="kw">const</span> moveMarble <span class="op">=</span> (<span class="op">{</span>x<span class="op">,</span> y<span class="op">,</span> vx<span class="op">,</span> vy<span class="op">,</span> id<span class="op">}</span>) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb175-6" title="6">        <span class="kw">let</span> _vx <span class="op">=</span> ((x<span class="op">+</span>vx <span class="op">&lt;</span> MarbleR) <span class="op">?</span> <span class="op">-</span>vx : (x<span class="op">+</span>vx <span class="op">&gt;</span> width<span class="op">-</span>MarbleR) <span class="op">?</span> <span class="op">-</span>vx : vx)<span class="op">*</span>.<span class="dv">99</span><span class="op">,</span></a>
<a class="sourceLine" id="cb175-7" title="7">            _vy <span class="op">=</span> ((y<span class="op">+</span>vy <span class="op">&lt;</span> MarbleR) <span class="op">?</span> <span class="op">-</span>vy : (y<span class="op">+</span>vy <span class="op">&gt;</span> height<span class="op">-</span>MarbleR) <span class="op">?</span> <span class="op">-</span>vy : vy)<span class="op">*</span>.<span class="dv">99</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-8" title="8"></a>
<a class="sourceLine" id="cb175-9" title="9">        <span class="co">// nearest marble is a collision candidate</span></a>
<a class="sourceLine" id="cb175-10" title="10">        <span class="kw">const</span> subdividedSpace <span class="op">=</span> <span class="at">quadtree</span>().<span class="at">extent</span>([[<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">-1</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb175-11" title="11">                                                   [<span class="kw">this</span>.<span class="at">width</span><span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">height</span><span class="op">+</span><span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb175-12" title="12">                                          .<span class="at">x</span>(d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">x</span>)</a>
<a class="sourceLine" id="cb175-13" title="13">                                          .<span class="at">y</span>(d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">y</span>)</a>
<a class="sourceLine" id="cb175-14" title="14">                                          .<span class="at">addAll</span>(<span class="kw">this</span>.<span class="at">marbles</span></a>
<a class="sourceLine" id="cb175-15" title="15">                                                      .<span class="at">filter</span>(m <span class="op">=&gt;</span> id <span class="op">!==</span> <span class="va">m</span>.<span class="at">id</span>))<span class="op">,</span></a>
<a class="sourceLine" id="cb175-16" title="16">              candidate <span class="op">=</span> <span class="va">subdividedSpace</span>.<span class="at">find</span>(x<span class="op">,</span> y<span class="op">,</span> MarbleR<span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-17" title="17"></a>
<a class="sourceLine" id="cb175-18" title="18">        <span class="cf">if</span> (candidate) <span class="op">{</span></a>
<a class="sourceLine" id="cb175-19" title="19"></a>
<a class="sourceLine" id="cb175-20" title="20">            <span class="co">// borrowing @air_hadoken&#39;s implementation from here:</span></a>
<a class="sourceLine" id="cb175-21" title="21">            <span class="co">// https://github.com/airhadoken/game_of_circles/blob/master/circles.js#L64</span></a>
<a class="sourceLine" id="cb175-22" title="22">            <span class="kw">const</span> cx <span class="op">=</span> <span class="va">candidate</span>.<span class="at">x</span><span class="op">,</span></a>
<a class="sourceLine" id="cb175-23" title="23">                  cy <span class="op">=</span> <span class="va">candidate</span>.<span class="at">y</span><span class="op">,</span></a>
<a class="sourceLine" id="cb175-24" title="24">                  normx <span class="op">=</span> cx <span class="op">-</span> x<span class="op">,</span></a>
<a class="sourceLine" id="cb175-25" title="25">                  normy <span class="op">=</span> cy <span class="op">-</span> y<span class="op">,</span></a>
<a class="sourceLine" id="cb175-26" title="26">                  dist <span class="op">=</span> (normx <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> normy <span class="op">**</span> <span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb175-27" title="27">                  c <span class="op">=</span> (_vx <span class="op">*</span> normx <span class="op">+</span> _vy <span class="op">*</span> normy) / dist <span class="op">*</span> <span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-28" title="28"></a>
<a class="sourceLine" id="cb175-29" title="29">            _vx <span class="op">=</span> (_vx <span class="op">-</span> c <span class="op">*</span> normx)/<span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-30" title="30">            _vy <span class="op">=</span> (_vy <span class="op">-</span> c <span class="op">*</span> normy)/<span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-31" title="31"></a>
<a class="sourceLine" id="cb175-32" title="32">            <span class="va">candidate</span>.<span class="at">vx</span> <span class="op">+=</span> <span class="op">-</span>_vx<span class="op">;</span></a>
<a class="sourceLine" id="cb175-33" title="33">            <span class="va">candidate</span>.<span class="at">vy</span> <span class="op">+=</span> <span class="op">-</span>_vy<span class="op">;</span></a>
<a class="sourceLine" id="cb175-34" title="34">            <span class="va">candidate</span>.<span class="at">x</span> <span class="op">+=</span> <span class="op">-</span>_vx<span class="op">;</span></a>
<a class="sourceLine" id="cb175-35" title="35">            <span class="va">candidate</span>.<span class="at">y</span> <span class="op">+=</span> <span class="op">-</span>_vy<span class="op">;</span></a>
<a class="sourceLine" id="cb175-36" title="36">        <span class="op">}</span></a>
<a class="sourceLine" id="cb175-37" title="37"></a>
<a class="sourceLine" id="cb175-38" title="38">        <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb175-39" title="39">            <span class="dt">x</span><span class="op">:</span> x <span class="op">+</span> _vx<span class="op">,</span></a>
<a class="sourceLine" id="cb175-40" title="40">            <span class="dt">y</span><span class="op">:</span> y <span class="op">+</span> _vy<span class="op">,</span></a>
<a class="sourceLine" id="cb175-41" title="41">            <span class="dt">vx</span><span class="op">:</span> _vx<span class="op">,</span></a>
<a class="sourceLine" id="cb175-42" title="42">            <span class="dt">vy</span><span class="op">:</span> _vy</a>
<a class="sourceLine" id="cb175-43" title="43">        <span class="op">}</span></a>
<a class="sourceLine" id="cb175-44" title="44">    <span class="op">};</span></a>
<a class="sourceLine" id="cb175-45" title="45"></a>
<a class="sourceLine" id="cb175-46" title="46">    <span class="kw">this</span>.<span class="va">marbles</span>.<span class="at">forEach</span>((marble<span class="op">,</span> i) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb175-47" title="47">        <span class="kw">const</span> <span class="op">{</span> x<span class="op">,</span> y<span class="op">,</span> vx<span class="op">,</span> vy <span class="op">}</span> <span class="op">=</span> <span class="at">moveMarble</span>(marble)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-48" title="48"></a>
<a class="sourceLine" id="cb175-49" title="49">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">x</span> <span class="op">=</span> x<span class="op">;</span></a>
<a class="sourceLine" id="cb175-50" title="50">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">y</span> <span class="op">=</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb175-51" title="51">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">vx</span> <span class="op">=</span> vx<span class="op">;</span></a>
<a class="sourceLine" id="cb175-52" title="52">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">vy</span> <span class="op">=</span> vy<span class="op">;</span></a>
<a class="sourceLine" id="cb175-53" title="53">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-54" title="54"><span class="op">}</span></a></code></pre></div>
<p>That‚Äôs a lot of code üòÖ. Let‚Äôs break it down.</p>
<p>You can think of <code>simulationStep</code> as a function and a loop. At the bottom, there is a <code>.forEach</code> that applies a <code>moveMarble</code> function to each marble.</p>
<div class="sourceCode" id="cb176" data-caption="Loop through marbles"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb176-1" title="1">    <span class="kw">this</span>.<span class="va">marbles</span>.<span class="at">forEach</span>((marble<span class="op">,</span> i) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb176-2" title="2">        <span class="kw">const</span> <span class="op">{</span> x<span class="op">,</span> y<span class="op">,</span> vx<span class="op">,</span> vy <span class="op">}</span> <span class="op">=</span> <span class="at">moveMarble</span>(marble)<span class="op">;</span></a>
<a class="sourceLine" id="cb176-3" title="3"></a>
<a class="sourceLine" id="cb176-4" title="4">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">x</span> <span class="op">=</span> x<span class="op">;</span></a>
<a class="sourceLine" id="cb176-5" title="5">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">y</span> <span class="op">=</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb176-6" title="6">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">vx</span> <span class="op">=</span> vx<span class="op">;</span></a>
<a class="sourceLine" id="cb176-7" title="7">        <span class="kw">this</span>.<span class="at">marbles</span>[i].<span class="at">vy</span> <span class="op">=</span> vy<span class="op">;</span></a>
<a class="sourceLine" id="cb176-8" title="8">    <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>We iterate over the list of marbles, feed them into <code>moveMarble</code>, get new properties, and save them in the main marbles array. MobX <em>should</em> allows us to change these values inside <code>moveMarble</code> and let MobX observables do the heavy lifting, but more explicit code is easier to read.</p>
<h5 id="movemarble">moveMarble</h5>
<p><code>moveMarble</code> is itself a hairy function. Stuff happens in 3 steps:</p>
<ol type="1">
<li>Handle collisions with walls</li>
<li>Find collision with closest other marble</li>
<li>Handle collision with marble</li>
</ol>
<p><strong>Handling collisions with walls</strong> happens in two lines of code. One per axis.</p>
<div class="sourceCode" id="cb177" data-caption="Detecting wall collisions"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb177-1" title="1"><span class="kw">let</span> _vx <span class="op">=</span> ((x<span class="op">+</span>vx <span class="op">&lt;</span> MarbleR) <span class="op">?</span> <span class="op">-</span>vx : (x<span class="op">+</span>vx <span class="op">&gt;</span> width<span class="op">-</span>MarbleR) <span class="op">?</span> <span class="op">-</span>vx : vx)<span class="op">*</span>.<span class="dv">99</span><span class="op">,</span></a>
<a class="sourceLine" id="cb177-2" title="2">    _vy <span class="op">=</span> ((y<span class="op">+</span>vy <span class="op">&lt;</span> MarbleR) <span class="op">?</span> <span class="op">-</span>vy : (y<span class="op">+</span>vy <span class="op">&gt;</span> height<span class="op">-</span>MarbleR) <span class="op">?</span> <span class="op">-</span>vy : vy)<span class="op">*</span>.<span class="dv">99</span><span class="op">;</span></a></code></pre></div>
<p>Nested ternary expressions are kinda messy, but good enough. If a marble is beyond any boundary, we reverse its direction. We <em>always</em> apply a <code>.99</code> friction coefficient so that marbles slow down.</p>
<p><strong>Finding collisions</strong> with the next closest marble happens using a quadtree. Since we don‚Äôt have too many marbles, we can build a new quadtree every time.</p>
<p>{aside} A quadtree is a way to subdivide space into areas. It lets us answer the question of ‚ÄúWhat‚Äôs close enough to me to possibly touch me?‚Äù without making too many position comparisons.</p>
<p>Checking every marble with every other marble produces 81 comparisons. Versus 2 comparisons using a quadtree. {/aside}</p>
<div class="sourceCode" id="cb178" data-caption="Finding collision candidates"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb178-1" title="1"><span class="co">// nearest marble is a collision candidate</span></a>
<a class="sourceLine" id="cb178-2" title="2"><span class="kw">const</span> subdividedSpace <span class="op">=</span> <span class="at">quadtree</span>().<span class="at">extent</span>([[<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">-1</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb178-3" title="3">                                           [<span class="kw">this</span>.<span class="at">width</span><span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">height</span><span class="op">+</span><span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb178-4" title="4">                                  .<span class="at">x</span>(d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">x</span>)</a>
<a class="sourceLine" id="cb178-5" title="5">                                  .<span class="at">y</span>(d <span class="op">=&gt;</span> <span class="va">d</span>.<span class="at">y</span>)</a>
<a class="sourceLine" id="cb178-6" title="6">                                  .<span class="at">addAll</span>(<span class="kw">this</span>.<span class="at">marbles</span></a>
<a class="sourceLine" id="cb178-7" title="7">                                              .<span class="at">filter</span>(m <span class="op">=&gt;</span> id <span class="op">!==</span> <span class="va">m</span>.<span class="at">id</span>))<span class="op">,</span></a>
<a class="sourceLine" id="cb178-8" title="8">      candidate <span class="op">=</span> <span class="va">subdividedSpace</span>.<span class="at">find</span>(x<span class="op">,</span> y<span class="op">,</span> MarbleR<span class="op">*</span><span class="dv">2</span>)<span class="op">;</span></a></code></pre></div>
<p>We‚Äôre using <a href="https://github.com/d3/d3-quadtree"><code>d3-quadtree</code></a> for the quadtree implementation. It takes an <code>extent</code>, which tells it how big our space is. An <code>x</code> and <code>y</code> accessor tells it how to get coordinates out of our marble objects, and we use <code>addAll</code> to fill the quadtree with marbles.</p>
<p>To avoid detecting each marble as colliding with itself, we take each marble out of our list before feeding the quadtree.</p>
<p>Once we have a quadtree, we use <code>.find</code> to look for the nearest marble within two radiuses ‚Äì¬†<code>MarbleR*2</code> ‚Äì of the current marble. That‚Äôs exactly the one we‚Äôre colliding with! :smile:</p>
<p><strong>Handling collisions with marbles</strong> involves math. The sort of thing you think you remember from high school, and suddenly realize you don‚Äôt when the time comes to use it.</p>
<p>Code looks like this:</p>
<div class="sourceCode" id="cb179" data-caption="Handling marble collisions"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb179-1" title="1"><span class="cf">if</span> (candidate) <span class="op">{</span></a>
<a class="sourceLine" id="cb179-2" title="2"></a>
<a class="sourceLine" id="cb179-3" title="3">    <span class="co">// borrowing @air_hadoken&#39;s implementation from here:</span></a>
<a class="sourceLine" id="cb179-4" title="4">    <span class="co">// https://github.com/airhadoken/game_of_circles/blob/master/circles.js#L64</span></a>
<a class="sourceLine" id="cb179-5" title="5">    <span class="kw">const</span> cx <span class="op">=</span> <span class="va">candidate</span>.<span class="at">x</span><span class="op">,</span></a>
<a class="sourceLine" id="cb179-6" title="6">          cy <span class="op">=</span> <span class="va">candidate</span>.<span class="at">y</span><span class="op">,</span></a>
<a class="sourceLine" id="cb179-7" title="7">          normx <span class="op">=</span> cx <span class="op">-</span> x<span class="op">,</span></a>
<a class="sourceLine" id="cb179-8" title="8">          normy <span class="op">=</span> cy <span class="op">-</span> y<span class="op">,</span></a>
<a class="sourceLine" id="cb179-9" title="9">          dist <span class="op">=</span> (normx <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> normy <span class="op">**</span> <span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb179-10" title="10">          c <span class="op">=</span> (_vx <span class="op">*</span> normx <span class="op">+</span> _vy <span class="op">*</span> normy) / dist <span class="op">*</span> <span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb179-11" title="11"></a>
<a class="sourceLine" id="cb179-12" title="12">    _vx <span class="op">=</span> (_vx <span class="op">-</span> c <span class="op">*</span> normx)/<span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb179-13" title="13">    _vy <span class="op">=</span> (_vy <span class="op">-</span> c <span class="op">*</span> normy)/<span class="fl">2.3</span><span class="op">;</span></a>
<a class="sourceLine" id="cb179-14" title="14"></a>
<a class="sourceLine" id="cb179-15" title="15">    <span class="va">candidate</span>.<span class="at">vx</span> <span class="op">+=</span> <span class="op">-</span>_vx<span class="op">;</span></a>
<a class="sourceLine" id="cb179-16" title="16">    <span class="va">candidate</span>.<span class="at">vy</span> <span class="op">+=</span> <span class="op">-</span>_vy<span class="op">;</span></a>
<a class="sourceLine" id="cb179-17" title="17">    <span class="va">candidate</span>.<span class="at">x</span> <span class="op">+=</span> <span class="op">-</span>_vx<span class="op">;</span></a>
<a class="sourceLine" id="cb179-18" title="18">    <span class="va">candidate</span>.<span class="at">y</span> <span class="op">+=</span> <span class="op">-</span>_vy<span class="op">;</span></a>
<a class="sourceLine" id="cb179-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb179-20" title="20"></a>
<a class="sourceLine" id="cb179-21" title="21"><span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb179-22" title="22">    <span class="dt">x</span><span class="op">:</span> x <span class="op">+</span> _vx<span class="op">,</span></a>
<a class="sourceLine" id="cb179-23" title="23">    <span class="dt">y</span><span class="op">:</span> y <span class="op">+</span> _vy<span class="op">,</span></a>
<a class="sourceLine" id="cb179-24" title="24">    <span class="dt">vx</span><span class="op">:</span> _vx<span class="op">,</span></a>
<a class="sourceLine" id="cb179-25" title="25">    <span class="dt">vy</span><span class="op">:</span> _vy</a>
<a class="sourceLine" id="cb179-26" title="26"><span class="op">}</span></a></code></pre></div>
<p>Ok, the <code>return</code> statement isn‚Äôt about handling collisions. It updates the current marble.</p>
<p>The rest looks like magic. I implemented it and it still looks like magic.</p>
<p>You can think of <code>[normx, normy]</code> as a vector that points from current marble to collision candidate. It gives us bounce direction. We use the <a href="https://en.wikipedia.org/wiki/Euclidean_distance">euclidean distance</a> formula to calculate the length of this vector. The distance between the centers of both marbles.</p>
<p>Then we calculate the <a href="https://en.wikipedia.org/wiki/Dot_product">dot product</a> between our marble‚Äôs speed vector and the collision direction vector. And we normalize it by distance. Multiplying distance by <code>2</code> accounts for there being two marbles in the collision. That extra <code>.3</code> made the simulation look better.</p>
<p>Fiddling and experimentation are your best tools for magic values like that üòâ</p>
<p>Then we use the dot product scalar to adjust the marble‚Äôs speed vector. Dividing by <code>2</code> takes into account that half the energy goes to the other marble. This is true because we assume their masses are equal.</p>
<p>Finally, we update the <code>candidate</code> marble and make sure it bounces off as well. We do it additively because that‚Äôs how it happens in real life.</p>
<p>Two marbles traveling towards each other in exactly opposite directions with exactly the same speed, will stop dead and stay there. As soon as there‚Äôs any misalignment, deflection happens. If one is stationary, it starts moving. If it‚Äôs moving in the same direction, it speeds up‚Ä¶ etc.</p>
<p>The end result is <a href="https://swizec.github.io/declarative-canvas-react-konva/">a decent-looking simulation of billiards</a>.</p>